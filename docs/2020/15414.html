<!DOCTYPE html>
<html lang=en>
           <head>
            <meta charset=UTF-8>
            <title>lispworks garbage collection thread</title>
            <meta name=viewport
                  content="width=device-width, initial-scale=1.0">
            <link rel=stylesheet
                  href=https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css
                  integrity=sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2
                  crossorigin=anonymous>
            <style>
section.tree {
    padding-left: 2em;
}
section.tree:first-child {
    padding-left: 0;
}
.article-link {
  margin-bottom: 1em;
}
</style>
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9X3G9MMWZP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-9X3G9MMWZP');
</script>

           </head>
           <body>
            <header class="d-flex justify-content-center">
             <nav
                  class="navbar navbar-light bg-light w-100 mx-5 mb-3">
              <a class=navbar-brand href="/">Lisp HUG Maillist Archive</a>
             </nav>
            </header>
            <div class="d-flex justify-content-center">
             <div class="w-100 mx-5 px-3">
              <section class=tree>
               <article class=email>
                <h1>lispworks garbage collection thread</h1>
                <p>
                 Unable to parse email body. Email id is 15414
               </article>
               <section class=tree>
                <article class=email>
                 <h1>Re: lispworks garbage collection thread</h1><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; line-break: after-white-space;" class="">I’m curious about any answers too. But from the man pages:<div class=""><br class=""></div><div class=""><span style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Palatino, &quot;Palatino Linotype&quot;, serif; font-size: 14.666666984558105px; background-color: rgb(255, 255, 255);" class="">It is normally less important to tune the ephemeral segments, that is the segments below the blocking generation. Functions that may be useful include&nbsp;</span><a name="marker-890100" style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Palatino, &quot;Palatino Linotype&quot;, serif; font-size: 14.666666984558105px;" class=""></a><a href="file:///Applications/LispWorks%207.1%20(64-bit)/Library/lib/7-1-0-0/manual/online/LW/html/lw-1432.htm#88236" class="XRef" style="font-family: Palatino, &quot;Palatino Linotype&quot;, serif; font-size: 14.666666984558105px;">set-default-segment-size</a><span style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Palatino, &quot;Palatino Linotype&quot;, serif; font-size: 14.666666984558105px; background-color: rgb(255, 255, 255);" class="">,&nbsp;</span><a name="marker-890105" style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Palatino, &quot;Palatino Linotype&quot;, serif; font-size: 14.666666984558105px;" class=""></a><a href="file:///Applications/LispWorks%207.1%20(64-bit)/Library/lib/7-1-0-0/manual/online/LW/html/lw-1445.htm#28295" class="XRef" style="font-family: Palatino, &quot;Palatino Linotype&quot;, serif; font-size: 14.666666984558105px;">set-spare-keeping-policy</a><span style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Palatino, &quot;Palatino Linotype&quot;, serif; font-size: 14.666666984558105px; background-color: rgb(255, 255, 255);" class="">&nbsp;and&nbsp;</span><a name="marker-890110" style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Palatino, &quot;Palatino Linotype&quot;, serif; font-size: 14.666666984558105px;" class=""></a><a href="file:///Applications/LispWorks%207.1%20(64-bit)/Library/lib/7-1-0-0/manual/online/LW/html/lw-1433.htm#65173" class="XRef" style="font-family: Palatino, &quot;Palatino Linotype&quot;, serif; font-size: 14.666666984558105px;">set-delay-promotion</a><span style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0); font-family: Palatino, &quot;Palatino Linotype&quot;, serif; font-size: 14.666666984558105px; background-color: rgb(255, 255, 255);" class="">.</span></div><div class=""><br class=""></div><div class="">They also discuss the various profiling tools that can (should?) be used to track down where the problem is. I see from your code that you focus on Gen 2. Why? That is supposedly one of the ephemeral generations.</div><div class=""><br class=""></div><div class="">- DM</div><div class=""><div><br class=""><blockquote type="cite" class=""><div class="">On Nov 9, 2020, at 6:15 PM, roy anderson &lt;<a href="mailto:reanz1959@gmail.com" class="">reanz1959@gmail.com</a>&gt; wrote:</div><br class="Apple-interchange-newline"><div class=""><div class="WordSection1" style="page: WordSection1; caret-color: rgb(0, 0, 0); font-family: Helvetica; font-size: 12px; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration: none;"><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">We are developing a document analysis application which puts pressure on the LispWorks 64bit Windows Professional garbage collector.<span class="Apple-converted-space">&nbsp;</span></div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class=""><o:p class="">&nbsp;</o:p></div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">In particular, everything stops for quite a while the gc is working from time to time.</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class=""><o:p class="">&nbsp;</o:p></div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">To reduce the impact of the gc. I am working on the code below to do automated garbage collection after either a certain number of tranactions or a set period.</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class=""><o:p class="">&nbsp;</o:p></div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">This seems to help our situation but are we missing something?</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class=""><o:p class="">&nbsp;</o:p></div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">Here’s our code:</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class=""><o:p class="">&nbsp;</o:p></div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">(defun memory-magnitude (bytes)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp; (let* ((kb (truncate bytes 1024))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (mb (truncate kb 1024))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (gb (truncate mb 1024))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (tb (truncate gb 1024))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (pb (truncate tb 1024)))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp; (format nil "~{~a~}"</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (cond</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop kb) (list bytes "B"))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop mb) (list kb "KB"))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop gb) (list mb "MB"))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop tb) (list gb "GB"))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop pb) (list tb "TB"))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (t (list pb "PB"))))))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class=""><o:p class="">&nbsp;</o:p></div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">(defun time-interval (start-transaction)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp; (let* ((ms (truncate (* 1000 (/ (- (get-internal-real-time) start-transaction)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; internal-time-units-per-second))))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (s (truncate ms 1000.0))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (min (truncate s 60))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (hours (truncate min 60))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (days (truncate hours 24)))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp; (format nil "~{~a~}"</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (cond</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop s) (list ms "msec"))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((zerop min) (list s "sec"))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop hours) (list min "min"))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop days) (list hours "hours"))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (t (list days "days"))))))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class=""><o:p class="">&nbsp;</o:p></div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">(defun report-garbage-collection (thread-name actions last-collection)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp; (let ((room (system:room-values)))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp; (format t "~a[" thread-name)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp; (unless (zerop actions)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (format t "~d Action~:p, " actions))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp; (format t "Slept: ~a] Total: ~a Free: ~a~%"</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (time-interval last-collection)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (memory-magnitude (getf room :TOTAL-SIZE))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (memory-magnitude (getf room :TOTAL-FREE)))))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class=""><o:p class="">&nbsp;</o:p></div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">(defparameter maximum-sleep-seconds (* 60 5)) ; i.e. 5 minutes<o:p class=""></o:p></div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">(defparameter transactions 0)<o:p class=""></o:p></div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class=""><o:p class="">&nbsp;</o:p></div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">(defun make-garbage-manager ()</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp; (let ((top-level *standard-output*)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (thread-name "garbage collector")</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (last-activity transactions)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (last-collection (get-internal-real-time))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (slept 0))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp; (flet ((garbage-man ()</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (let ((*standard-output* top-level))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (loop</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while t do</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (sleep 10)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (incf slept 10)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (let ((actions (- transactions last-activity)))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (when (or (&gt; actions 5)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (&gt; slept maximum-sleep-seconds)) ; i.e. more than limit before gc</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (hcl:gc-generation 2)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (report-garbage-collection thread-name actions last-collection)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (setf last-collection (get-internal-real-time))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (setf last-activity transactions)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (setf slept 0)))))))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (mp:process-run-function thread-name () #'garbage-man))))<span class="Apple-converted-space">&nbsp;</span></div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class=""><o:p class="">&nbsp;</o:p></div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">(make-garbage-manager)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class=""><o:p class="">&nbsp;</o:p></div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">Sent from<span class="Apple-converted-space">&nbsp;</span><a href="https://go.microsoft.com/fwlink/?LinkId=550986" style="color: blue; text-decoration: underline;" class="">Mail</a><span class="Apple-converted-space">&nbsp;</span>for Windows 10</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class=""><o:p class="">&nbsp;</o:p></div></div><span style="caret-color: rgb(0, 0, 0); font-family: Helvetica; font-size: 12px; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration: none; float: none; display: inline !important;" class="">.+)�-�隊X�X�+.+)Z�����b�n�X� +��(�m��� b�(�K�o캚h����a�m</span></div></blockquote></div><br class=""></div></body></html>

                </article>
               </section>
               <section class=tree>
                <article class=email>
                 <h1>Re: lispworks garbage collection thread</h1><div dir="ltr"><div>Hi,</div><div><br></div><div>Maybe one of the potential ways to tackle the problem is to not to generate garbage? I.e. pre-allocate as many objects as needed on startup of the application, use object pools etc. <br></div><div><br></div><div>BR,</div><div>/Alexey<br></div></div><br><div class="gmail_quote"><div dir="ltr" class="gmail_attr">On Tue, Nov 10, 2020 at 2:17 AM roy anderson &lt;<a href="mailto:reanz1959@gmail.com">reanz1959@gmail.com</a>&gt; wrote:<br></div><blockquote class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"><div lang="EN-NZ"><div class="gmail-m_5217027234078281541WordSection1"><p class="MsoNormal">We are developing a document analysis application which puts pressure on the LispWorks 64bit Windows Professional garbage collector. </p><p class="MsoNormal"><u></u> <u></u></p><p class="MsoNormal">In particular, everything stops for quite a while the gc is working from time to time.</p><p class="MsoNormal"><u></u> <u></u></p><p class="MsoNormal">To reduce the impact of the gc. I am working on the code below to do automated garbage collection after either a certain number of tranactions or a set period.</p><p class="MsoNormal"><u></u> <u></u></p><p class="MsoNormal">This seems to help our situation but are we missing something?</p><p class="MsoNormal"><u></u> <u></u></p><p class="MsoNormal">Here’s our code:</p><p class="MsoNormal"><u></u> <u></u></p><p class="MsoNormal">(defun memory-magnitude (bytes)</p><p class="MsoNormal">  (let* ((kb (truncate bytes 1024))</p><p class="MsoNormal">         (mb (truncate kb 1024))</p><p class="MsoNormal">         (gb (truncate mb 1024))</p><p class="MsoNormal">         (tb (truncate gb 1024))</p><p class="MsoNormal">         (pb (truncate tb 1024)))</p><p class="MsoNormal">    (format nil &quot;~{~a~}&quot;</p><p class="MsoNormal">           (cond</p><p class="MsoNormal">            ((zerop kb) (list bytes &quot;B&quot;))</p><p class="MsoNormal">            ((zerop mb) (list kb &quot;KB&quot;))</p><p class="MsoNormal">            ((zerop gb) (list mb &quot;MB&quot;))</p><p class="MsoNormal">            ((zerop tb) (list gb &quot;GB&quot;))</p><p class="MsoNormal">            ((zerop pb) (list tb &quot;TB&quot;))</p><p class="MsoNormal">            (t (list pb &quot;PB&quot;))))))</p><p class="MsoNormal"><u></u> <u></u></p><p class="MsoNormal">(defun time-interval (start-transaction)</p><p class="MsoNormal">  (let* ((ms (truncate (* 1000 (/ (- (get-internal-real-time) start-transaction)</p><p class="MsoNormal">                                  internal-time-units-per-second))))</p><p class="MsoNormal">          (s (truncate ms 1000.0))</p><p class="MsoNormal">          (min (truncate s 60))</p><p class="MsoNormal">          (hours (truncate min 60))</p><p class="MsoNormal">          (days (truncate hours 24)))</p><p class="MsoNormal">    (format nil &quot;~{~a~}&quot;</p><p class="MsoNormal">            (cond</p><p class="MsoNormal">             ((zerop s) (list ms &quot;msec&quot;))</p><p class="MsoNormal">             ((zerop min) (list s &quot;sec&quot;))</p><p class="MsoNormal">             ((zerop hours) (list min &quot;min&quot;))</p><p class="MsoNormal">             ((zerop days) (list hours &quot;hours&quot;))</p><p class="MsoNormal">             (t (list days &quot;days&quot;))))))</p><p class="MsoNormal"><u></u> <u></u></p><p class="MsoNormal">(defun report-garbage-collection (thread-name actions last-collection)</p><p class="MsoNormal">  (let ((room (system:room-values)))</p><p class="MsoNormal">    (format t &quot;~a[&quot; thread-name)</p><p class="MsoNormal">    (unless (zerop actions)</p><p class="MsoNormal">      (format t &quot;~d Action~:p, &quot; actions))</p><p class="MsoNormal">    (format t &quot;Slept: ~a] Total: ~a Free: ~a~%&quot;</p><p class="MsoNormal">            (time-interval last-collection)</p><p class="MsoNormal">            (memory-magnitude (getf room :TOTAL-SIZE))</p><p class="MsoNormal">            (memory-magnitude (getf room :TOTAL-FREE)))))</p><p class="MsoNormal"><u></u> <u></u></p><p class="MsoNormal">(defparameter maximum-sleep-seconds (* 60 5)) ; i.e. 5 minutes<u></u><u></u></p><p class="MsoNormal">(defparameter transactions 0)<u></u><u></u></p><p class="MsoNormal"><u></u> <u></u></p><p class="MsoNormal">(defun make-garbage-manager ()</p><p class="MsoNormal">  (let ((top-level *standard-output*)</p><p class="MsoNormal">        (thread-name &quot;garbage collector&quot;)</p><p class="MsoNormal">        (last-activity transactions)</p><p class="MsoNormal">        (last-collection (get-internal-real-time))</p><p class="MsoNormal">        (slept 0))</p><p class="MsoNormal">    (flet ((garbage-man ()</p><p class="MsoNormal">      (let ((*standard-output* top-level))</p><p class="MsoNormal">        (loop</p><p class="MsoNormal">            while t do</p><p class="MsoNormal">            (sleep 10)</p><p class="MsoNormal">            (incf slept 10)</p><p class="MsoNormal">            (let ((actions (- transactions last-activity)))</p><p class="MsoNormal">              (when (or (&gt; actions 5)</p><p class="MsoNormal">                        (&gt; slept maximum-sleep-seconds)) ; i.e. more than limit before gc</p><p class="MsoNormal">                (hcl:gc-generation 2)</p><p class="MsoNormal">                (report-garbage-collection thread-name actions last-collection)</p><p class="MsoNormal">                (setf last-collection (get-internal-real-time))</p><p class="MsoNormal">                (setf last-activity transactions)</p><p class="MsoNormal">                (setf slept 0)))))))</p><p class="MsoNormal">      (mp:process-run-function thread-name () #&#39;garbage-man)))) </p><p class="MsoNormal"><u></u> <u></u></p><p class="MsoNormal">(make-garbage-manager)</p><p class="MsoNormal"><u></u> <u></u></p><p class="MsoNormal">Sent from <a href="https://go.microsoft.com/fwlink/?LinkId=550986" target="_blank">Mail</a> for Windows 10</p><p class="MsoNormal"><u></u> <u></u></p></div></div></blockquote></div>


                </article>
               </section>
               <section class=tree>
                <article class=email>
                 <h1>Re: lispworks garbage collection thread</h1><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"></head><body dir="auto">Hi!<div><br></div><div>At Netfonds, we had lots of heavy server applications that would run for months non stop, and they all had our own gc management code built in.&nbsp;</div><div><br></div><div>This consisted of:</div><div>1) “Cron in lisp” - a lisp thread similar to the cron Unix tool which was used to run programs at regular intervals</div><div>2) A gc function called from cron which checked the amount of memory used, and decided (according to limits set by the app) whether it’s time for a global GC - which btw is generation 3, not 2 (we also on some occasions collected gen 7, but that’s not useful on a regular schedule).&nbsp;</div><div><br></div><div>For most of the apps, the gc function would typically run once or twice per day. Since we were a stock trading provider, we would typically have vast amounts of market data from yesterday that turned into garbage each morning, so in some apps a morning gc was run regardless of the memory usage monitoring.&nbsp;</div><div><div dir="ltr"><br></div><div dir="ltr">Hope this helps!</div><div dir="ltr"><br></div><div dir="ltr">Regards,</div><div dir="ltr">&nbsp; Espen Vestre</div><div dir="ltr"><br><blockquote type="cite">10. nov. 2020 kl.&nbsp;02:17 skrev roy anderson &lt;reanz1959@gmail.com&gt;:<br><br></blockquote></div><blockquote type="cite"><div dir="ltr">﻿<meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="Generator" content="Microsoft Word 15 (filtered medium)"><style><!--
/* Font Definitions */
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
/* Style Definitions */
p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0cm;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
a:link, span.MsoHyperlink
	{mso-style-priority:99;
	color:blue;
	text-decoration:underline;}
..MsoChpDefault
	{mso-style-type:export-only;}
@page WordSection1
	{size:612.0pt 792.0pt;
	margin:72.0pt 72.0pt 72.0pt 72.0pt;}
div.WordSection1
	{page:WordSection1;}
--></style><div class="WordSection1"><p class="MsoNormal">We are developing a document analysis application which puts pressure on the LispWorks 64bit Windows Professional garbage collector. </p><p class="MsoNormal"><o:p>&nbsp;</o:p></p><p class="MsoNormal">In particular, everything stops for quite a while the gc is working from time to time.</p><p class="MsoNormal"><o:p>&nbsp;</o:p></p><p class="MsoNormal">To reduce the impact of the gc. I am working on the code below to do automated garbage collection after either a certain number of tranactions or a set period.</p><p class="MsoNormal"><o:p>&nbsp;</o:p></p><p class="MsoNormal">This seems to help our situation but are we missing something?</p><p class="MsoNormal"><o:p>&nbsp;</o:p></p><p class="MsoNormal">HereвЂ™s our code:</p><p class="MsoNormal"><o:p>&nbsp;</o:p></p><p class="MsoNormal">(defun memory-magnitude (bytes)</p><p class="MsoNormal">В&nbsp; (let* ((kb (truncate bytes 1024))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (mb (truncate kb 1024))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (gb (truncate mb 1024))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (tb (truncate gb 1024))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (pb (truncate tb 1024)))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp; (format nil "~{~a~}"</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (cond</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; ((zerop kb) (list bytes "B"))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; ((zerop mb) (list kb "KB"))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; ((zerop gb) (list mb "MB"))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; ((zerop tb) (list gb "GB"))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; ((zerop pb) (list tb "TB"))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (t (list pb "PB"))))))</p><p class="MsoNormal"><o:p>&nbsp;</o:p></p><p class="MsoNormal">(defun time-interval (start-transaction)</p><p class="MsoNormal">В&nbsp; (let* ((ms (truncate (* 1000 (/ (- (get-internal-real-time) start-transaction)</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; internal-time-units-per-second))))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (s (truncate ms 1000.0))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (min (truncate s 60))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (hours (truncate min 60))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (days (truncate hours 24)))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp; (format nil "~{~a~}"</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (cond</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; ((zerop s) (list ms "msec"))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp; В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;((zerop min) (list s "sec"))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; ((zerop hours) (list min "min"))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; ((zerop days) (list hours "hours"))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (t (list days "days"))))))</p><p class="MsoNormal"><o:p>&nbsp;</o:p></p><p class="MsoNormal">(defun report-garbage-collection (thread-name actions last-collection)</p><p class="MsoNormal">В&nbsp; (let ((room (system:room-values)))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp; (format t "~a[" thread-name)</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp; (unless (zerop actions)</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (format t "~d Action~:p, " actions))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp; (format t "Slept: ~a] Total: ~a Free: ~a~%"</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (time-interval last-collection)</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (memory-magnitude (getf room :TOTAL-SIZE))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (memory-magnitude (getf room :TOTAL-FREE)))))</p><p class="MsoNormal"><o:p>&nbsp;</o:p></p><p class="MsoNormal">(defparameter maximum-sleep-seconds (* 60 5)) ; i..e. 5 minutes<o:p></o:p></p><p class="MsoNormal">(defparameter transactions 0)<o:p></o:p></p><p class="MsoNormal"><o:p>&nbsp;</o:p></p><p class="MsoNormal">(defun make-garbage-manager ()</p><p class="MsoNormal">В&nbsp; (let ((top-level *standard-output*)</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (thread-name "garbage collector")</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (last-activity transactions)</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (last-collection (get-internal-real-time))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (slept 0))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp; (flet ((garbage-man ()</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (let ((*standard-output* top-level))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (loop</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; while t do</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (sleep 10)</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (incf slept 10)</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (let ((actions (- transactions last-activity)))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (when (or (&gt; actions 5)</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (&gt; slept maximum-sleep-seconds)) ; i.e. more than limit before gc</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (hcl:gc-generation 2)</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (report-garbage-collection thread-name actions last-collection)</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (setf last-collection (get-internal-real-time))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (setf last-activity transactions)</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (setf slept 0)))))))</p><p class="MsoNormal">В&nbsp;В&nbsp;В&nbsp;В&nbsp;В&nbsp; (mp:process-run-function thread-name () #'garbage-man)))) </p><p class="MsoNormal"><o:p>&nbsp;</o:p></p><p class="MsoNormal">(make-garbage-manager)</p><p class="MsoNormal"><o:p>&nbsp;</o:p></p><p class="MsoNormal">Sent from <a href="https://go.microsoft.com/fwlink/?LinkId=550986">Mail</a> for Windows 10</p><p class="MsoNormal"><o:p>&nbsp;</o:p></p></div>вІ‘о‚Ш^™ЁҐЉx%ЉЛ_ўІвІ•Ё®K.±км–+)†и%ЉКpў№,r‰Ў¶Ъя0–+)ВЉд±К&amp;юЛ©¦ЉнюX¬¦&nbsp;†ЩҐ</div></blockquote></div></body></html>

                </article>
               </section>
               <section class=tree>
                <article class=email>
                 <h1>RE: lispworks garbage collection thread</h1><html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns:m="http://schemas.microsoft.com/office/2004/12/omml" xmlns="http://www.w3.org/TR/REC-html40"><head><meta http-equiv=Content-Type content="text/html; charset=utf-8"><meta name=Generator content="Microsoft Word 15 (filtered medium)"><style><!--
/* Font Definitions */
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
/* Style Definitions */
p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0cm;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
a:link, span.MsoHyperlink
	{mso-style-priority:99;
	color:blue;
	text-decoration:underline;}
..MsoChpDefault
	{mso-style-type:export-only;}
@page WordSection1
	{size:612.0pt 792.0pt;
	margin:72.0pt 72.0pt 72.0pt 72.0pt;}
div.WordSection1
	{page:WordSection1;}
--></style></head><body lang=EN-NZ link=blue vlink="#954F72"><div class=WordSection1><p class=MsoNormal>Calling hcl:gc-generation  with generation 3 with the thread below causes frequent medium duration GC calls. Still better than the default periodic “stop the world” GC.</p><p class=MsoNormal><o:p>&nbsp;</o:p></p><p class=MsoNormal>Now testing GC generation 2.</p><p class=MsoNormal><o:p>&nbsp;</o:p></p><div style='mso-element:para-border-div;border:none;border-top:solid #E1E1E1 1.0pt;padding:3.0pt 0cm 0cm 0cm'><p class=MsoNormal style='border:none;padding:0cm'><b>From: </b><a href="mailto:vogt@cox.net">cjv</a><br><b>Sent: </b>Wednesday, 11 November 2020 4:55 AM<br><b>To: </b><a href="mailto:txm.fourier@gmail.com">Alexey Veretennikov</a><br><b>Cc: </b><a href="mailto:reanz1959@gmail.com">roy anderson</a>; <a href="mailto:lisp-hug@lispworks.com">lisp-hug@lispworks.com</a>; <a href="mailto:peter.smyth@xtra.co.nz">Peter Smyth</a><br><b>Subject: </b>Re: lispworks garbage collection thread</p></div><p class=MsoNormal><o:p>&nbsp;</o:p></p><p class=MsoNormal>I concur with Alexey. &nbsp;My experience has been that futzing around with gc parameters is a waste of time. &nbsp;Getting you application to stop consing is where you can really improve gc performance. &nbsp;<o:p></o:p></p><div><p class=MsoNormal><br><br><o:p></o:p></p><blockquote style='margin-top:5.0pt;margin-bottom:5.0pt'><div><p class=MsoNormal>On Nov 10, 2020, at 12:41 AM, Alexey Veretennikov &lt;<a href="mailto:txm.fourier@gmail.com">txm.fourier@gmail.com</a>&gt; wrote:<o:p></o:p></p></div><p class=MsoNormal><o:p>&nbsp;</o:p></p><div><div><div><p class=MsoNormal>Hi,<o:p></o:p></p></div><div><p class=MsoNormal><o:p>&nbsp;</o:p></p></div><div><p class=MsoNormal>Maybe one of the potential ways to tackle the problem is to not to generate garbage? I.e. pre-allocate as many objects as needed on startup of the application, use object pools etc. <o:p></o:p></p></div><div><p class=MsoNormal><o:p>&nbsp;</o:p></p></div><div><p class=MsoNormal>BR,<o:p></o:p></p></div><div><p class=MsoNormal>/Alexey<o:p></o:p></p></div></div><p class=MsoNormal><o:p>&nbsp;</o:p></p><div><div><p class=MsoNormal>On Tue, Nov 10, 2020 at 2:17 AM roy anderson &lt;<a href="mailto:reanz1959@gmail.com">reanz1959@gmail.com</a>&gt; wrote:<o:p></o:p></p></div><blockquote style='border:none;border-left:solid #CCCCCC 1.0pt;padding:0cm 0cm 0cm 6.0pt;margin-left:4.8pt;margin-right:0cm'><div><div><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>We are developing a document analysis application which puts pressure on the LispWorks 64bit Windows Professional garbage collector. </p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>In particular, everything stops for quite a while the gc is working from time to time.</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>To reduce the impact of the gc. I am working on the code below to do automated garbage collection after either a certain number of tranactions or a set period.</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>This seems to help our situation but are we missing something?</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>Here’s our code:</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>(defun memory-magnitude (bytes)</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp; (let* ((kb (truncate bytes 1024))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (mb (truncate kb 1024))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (gb (truncate mb 1024))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (tb (truncate gb 1024))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (pb (truncate tb 1024)))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp; (format nil &quot;~{~a~}&quot;</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (cond</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop kb) (list bytes &quot;B&quot;))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop mb) (list kb &quot;KB&quot;))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop gb) (list mb &quot;MB&quot;))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop tb) (list gb &quot;GB&quot;))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop pb) (list tb &quot;TB&quot;))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (t (list pb &quot;PB&quot;))))))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>(defun time-interval (start-transaction)</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp; (let* ((ms (truncate (* 1000 (/ (- (get-internal-real-time) start-transaction)</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; internal-time-units-per-second))))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (s (truncate ms 1000.0))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (min (truncate s 60))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (hours (truncate min 60))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (days (truncate hours 24)))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp; (format nil &quot;~{~a~}&quot;</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (cond</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop s) (list ms &quot;msec&quot;))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((zerop min) (list s &quot;sec&quot;))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop hours) (list min &quot;min&quot;))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop days) (list hours &quot;hours&quot;))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (t (list days &quot;days&quot;))))))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>(defun report-garbage-collection (thread-name actions last-collection)</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp; (let ((room (system:room-values)))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp; (format t &quot;~a[&quot; thread-name)</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp; (unless (zerop actions)</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (format t &quot;~d Action~:p, &quot; actions))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp; (format t &quot;Slept: ~a] Total: ~a Free: ~a~%&quot;</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (time-interval last-collection)</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (memory-magnitude (getf room :TOTAL-SIZE))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (memory-magnitude (getf room :TOTAL-FREE)))))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>(defparameter maximum-sleep-seconds (* 60 5)) ; i.e. 5 minutes</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>(defparameter transactions 0)</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>(defun make-garbage-manager ()</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp; (let ((top-level *standard-output*)</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (thread-name &quot;garbage collector&quot;)</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (last-activity transactions)</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (last-collection (get-internal-real-time))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (slept 0))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp; (flet ((garbage-man ()</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (let ((*standard-output* top-level))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (loop</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while t do</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (sleep 10)</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (incf slept 10)</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (let ((actions (- transactions last-activity)))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (when (or (&gt; actions 5)</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (&gt; slept maximum-sleep-seconds)) ; i.e. more than limit before gc</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (hcl:gc-generation 2)</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (report-garbage-collection thread-name actions last-collection)</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (setf last-collection (get-internal-real-time))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (setf last-activity transactions)</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (setf slept 0)))))))</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (mp:process-run-function thread-name () #'garbage-man)))) </p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>(make-garbage-manager)</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>Sent from <a href="https://go.microsoft.com/fwlink/?LinkId=550986" target="_blank">Mail</a> for Windows 10</p><p class=MsoNormal style='mso-margin-top-alt:auto;mso-margin-bottom-alt:auto'>&nbsp;</p></div></div></blockquote></div></div></blockquote></div><p class=MsoNormal><o:p>&nbsp;</o:p></p><p class=MsoNormal><o:p>&nbsp;</o:p></p></div></body></html>
_______________________________________________
Lisp Hug - the mailing list for LispWorks users
lisp-hug@lispworks.com
http://www.lispworks.com/support/lisp-hug.html


                </article>
               </section>
               <section class=tree>
                <article class=email>
                 <h1>RE: lispworks garbage collection thread</h1><html xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns:m="http://schemas.microsoft.com/office/2004/12/omml" xmlns="http://www.w3.org/TR/REC-html40"><head><meta http-equiv=Content-Type content="text/html; charset=utf-8"><meta name=Generator content="Microsoft Word 15 (filtered medium)"><!--[if !mso]><style>v\:* {behavior:url(#default#VML);}
o\:* {behavior:url(#default#VML);}
w\:* {behavior:url(#default#VML);}
..shape {behavior:url(#default#VML);}
</style><![endif]--><style><!--
/* Font Definitions */
@font-face
	{font-family:Helvetica;
	panose-1:2 11 5 4 2 2 2 2 2 4;}
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
@font-face
	{font-family:"Calibri Light";
	panose-1:2 15 3 2 2 2 4 3 2 4;}
/* Style Definitions */
p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0cm;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
h2
	{mso-style-priority:9;
	mso-style-link:"Heading 2 Char";
	margin-top:2.0pt;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:0cm;
	page-break-after:avoid;
	font-size:13.0pt;
	font-family:"Calibri Light",sans-serif;
	color:#2F5496;
	font-weight:normal;}
a:link, span.MsoHyperlink
	{mso-style-priority:99;
	color:blue;
	text-decoration:underline;}
span.apple-converted-space
	{mso-style-name:apple-converted-space;}
span.Heading2Char
	{mso-style-name:"Heading 2 Char";
	mso-style-priority:9;
	mso-style-link:"Heading 2";
	font-family:"Calibri Light",sans-serif;
	color:#2F5496;}
..MsoChpDefault
	{mso-style-type:export-only;}
@page WordSection1
	{size:612.0pt 792.0pt;
	margin:72.0pt 72.0pt 72.0pt 72.0pt;}
div.WordSection1
	{page:WordSection1;}
--></style></head><body lang=EN-NZ link=blue vlink="#954F72"><div class=WordSection1><h2>My computer has 16GB RAM</h2><p class=MsoNormal><o:p>&nbsp;</o:p></p><p class=MsoNormal>On starting Lispworks:</p><p class=MsoNormal><o:p>&nbsp;</o:p></p><p class=MsoNormal>CL-USER 3 &gt; (system:room-values)</p><p class=MsoNormal>(:TOTAL-SIZE 121634816 :TOTAL-ALLOCATED 42347120 :TOTAL-FREE 76461456)</p><p class=MsoNormal><o:p>&nbsp;</o:p></p><p class=MsoNormal>After the application has completed caching </p><p class=MsoNormal><o:p>&nbsp;</o:p></p><p class=MsoNormal>CL-USER 7 &gt; (system:room-values)</p><p class=MsoNormal>(:TOTAL-SIZE 4795203584 :TOTAL-ALLOCATED 4017765336 :TOTAL-FREE 637015080)</p><p class=MsoNormal><o:p>&nbsp;</o:p></p><p class=MsoNormal>First output from the gc thread:</p><p class=MsoNormal><o:p>&nbsp;</o:p></p><p class=MsoNormal>garbage collector[Slept: 5min] Total: 4GB Free: 662MB</p><h2><o:p>&nbsp;</o:p></h2><p class=MsoNormal><img width=666 height=593 style='width:6.9375in;height:6.177in' id="Picture_x0020_3" src="cid:image001.png@01D6B9AE.8EAC6880"></p><h2>Here is room full immediately after starting LispWorks</h2><p class=MsoNormal><o:p>&nbsp;</o:p></p><p class=MsoNormal>CL-USER 2 &gt; (room :full)</p><p class=MsoNormal> &gt; Generation 7: 34755920 (0x2125550)</p><p class=MsoNormal>       Cons               5047088 (0x4D0330)</p><p class=MsoNormal>       Non-Pointer        3045240 (0x2E7778)</p><p class=MsoNormal>       Other              8532072 (0x823068)</p><p class=MsoNormal>       Symbol             3130272 (0x2FC3A0)</p><p class=MsoNormal>       Function           14697672 (0xE044C8)</p><p class=MsoNormal>       Non-Pointer-Static 21120 (0x5280)</p><p class=MsoNormal>       Mixed-Static       281776 (0x44CB0)</p><p class=MsoNormal>       Weak               680 (0x2A8)</p><p class=MsoNormal> &gt; Generation 6: 0 (0x0)</p><p class=MsoNormal> &gt; Generation 5: 0 (0x0)</p><p class=MsoNormal> &gt; Generation 4: 0 (0x0)</p><p class=MsoNormal> &gt; Generation 3: 13792 (0x35E0)</p><p class=MsoNormal>       Non-Pointer        5824 (0x16C0)</p><p class=MsoNormal>       Symbol             7968 (0x1F20)</p><p class=MsoNormal> &gt; Generation 2: 3058864 (0x2EACB0)</p><p class=MsoNormal>       Non-Pointer        2097160 (0x200008)</p><p class=MsoNormal>       Non-Pointer-Static 961704 (0xEACA8)</p><p class=MsoNormal> &gt; Generation 1: 1592160 (0x184B60)</p><p class=MsoNormal>       Cons               431472 (0x69570)</p><p class=MsoNormal>       Non-Pointer        53536 (0xD120)</p><p class=MsoNormal>       Other              940576 (0xE5A20)</p><p class=MsoNormal>       Symbol             96 (0x60)</p><p class=MsoNormal>       Function           166320 (0x289B0)</p><p class=MsoNormal>       Weak               160 (0xA0)</p><p class=MsoNormal> &gt; Generation 0: 1747632 (0x1AAAB0)</p><p class=MsoNormal>       Cons               858048 (0xD17C0)</p><p class=MsoNormal>       Non-Pointer        176096 (0x2AFE0)</p><p class=MsoNormal>       Other              681168 (0xA64D0)</p><p class=MsoNormal>       Symbol             288 (0x120)</p><p class=MsoNormal>       Function           31968 (0x7CE0)</p><p class=MsoNormal>       Weak               64 (0x40)</p><p class=MsoNormal><o:p>&nbsp;</o:p></p><p class=MsoNormal>Total allocated 41168368 (0x2742DF0), total size 121634816 (0x7400000)</p><p class=MsoNormal><o:p>&nbsp;</o:p></p><h2>And here’s room after loading the applications cache</h2><p class=MsoNormal><o:p>&nbsp;</o:p></p><p class=MsoNormal>CL-USER 2 &gt; (room :full)<o:p></o:p></p><p class=MsoNormal> &gt; Generation 7: 34758720 (0x2126040)<o:p></o:p></p><p class=MsoNormal>       Cons               5047088 (0x4D0330)<o:p></o:p></p><p class=MsoNormal>       Non-Pointer        3045240 (0x2E7778)<o:p></o:p></p><p class=MsoNormal>       Other              8532072 (0x823068)<o:p></o:p></p><p class=MsoNormal>       Symbol             3130272 (0x2FC3A0)<o:p></o:p></p><p class=MsoNormal>       Function           14697672 (0xE044C8)<o:p></o:p></p><p class=MsoNormal>       Non-Pointer-Static 21120 (0x5280)<o:p></o:p></p><p class=MsoNormal>       Mixed-Static       284576 (0x457A0)<o:p></o:p></p><p class=MsoNormal>       Weak               680 (0x2A8)<o:p></o:p></p><p class=MsoNormal> &gt; Generation 6: 0 (0x0)<o:p></o:p></p><p class=MsoNormal> &gt; Generation 5: 0 (0x0)<o:p></o:p></p><p class=MsoNormal> &gt; Generation 4: 0 (0x0)<o:p></o:p></p><p class=MsoNormal> &gt; Generation 3: 2941556808 (0xAF549848)<o:p></o:p></p><p class=MsoNormal>       Cons               668503360 (0x27D88D40)<o:p></o:p></p><p class=MsoNormal>       Non-Pointer        1151455496 (0x44A1D108)<o:p></o:p></p><p class=MsoNormal>       Other              1113444848 (0x425DD1F0)<o:p></o:p></p><p class=MsoNormal>       Symbol             1044096 (0xFEE80)<o:p></o:p></p><p class=MsoNormal>       Function           7107616 (0x6C7420)<o:p></o:p></p><p class=MsoNormal>       Weak               1392 (0x570)<o:p></o:p></p><p class=MsoNormal> &gt; Generation 2: 810159440 (0x304A0D50)<o:p></o:p></p><p class=MsoNormal>       Cons               185817632 (0xB135A20)<o:p></o:p></p><p class=MsoNormal>       Non-Pointer        365137104 (0x15C38CD0)<o:p></o:p></p><p class=MsoNormal>       Other              257178344 (0xF543AE8)<o:p></o:p></p><p class=MsoNormal>       Function           32 (0x20)<o:p></o:p></p><p class=MsoNormal>       Non-Pointer-Static 2026328 (0x1EEB58)<o:p></o:p></p><p class=MsoNormal> &gt; Generation 1: 319100400 (0x130515F0)<o:p></o:p></p><p class=MsoNormal>       Cons               97253280 (0x5CBF7A0)<o:p></o:p></p><p class=MsoNormal>       Non-Pointer        70191936 (0x42F0B40)<o:p></o:p></p><p class=MsoNormal>       Other              151654768 (0x90A1170)<o:p></o:p></p><p class=MsoNormal>       Function           416 (0x1A0)<o:p></o:p></p><p class=MsoNormal> &gt; Generation 0: 32799616 (0x1F47B80)<o:p></o:p></p><p class=MsoNormal>       Cons               11761568 (0xB377A0)<o:p></o:p></p><p class=MsoNormal>       Non-Pointer        1156088 (0x11A3F8)<o:p></o:p></p><p class=MsoNormal>       Other              19807880 (0x12E3E88)<o:p></o:p></p><p class=MsoNormal>       Function           74080 (0x12160)<o:p></o:p></p><p class=MsoNormal><o:p>&nbsp;</o:p></p><p class=MsoNormal>Total allocated 4138374984 (0xF6AA9748), total size 5316214784 (0x13CDF0000)<o:p></o:p></p><p class=MsoNormal><o:p>&nbsp;</o:p></p><p class=MsoNormal><o:p>&nbsp;</o:p></p><div style='mso-element:para-border-div;border:none;border-top:solid #E1E1E1 1.0pt;padding:3.0pt 0cm 0cm 0cm'><p class=MsoNormal style='border:none;padding:0cm'><b>From: </b><a href="mailto:vogt@cox.net">cjv</a><br><b>Sent: </b>Friday, 13 November 2020 10:31 AM<br><b>To: </b><a href="mailto:reanz1959@gmail.com">roy anderson</a><br><b>Cc: </b><a href="mailto:txm.fourier@gmail.com">Alexey Veretennikov</a>; <a href="mailto:lisp-hug@lispworks.com">lisp-hug@lispworks.com</a>; <a href="mailto:peter.smyth@xtra.co.nz">Peter Smyth</a><br><b>Subject: </b>Re: lispworks garbage collection thread</p></div><p class=MsoNormal><o:p>&nbsp;</o:p></p><p class=MsoNormal>Are you paging? &nbsp;<o:p></o:p></p><div><p class=MsoNormal>What is the size of your physical memory, and what is the size of your process? &nbsp;<o:p></o:p></p></div><div><p class=MsoNormal>It bothers me that you say “stop the world GC” as that isn’t supposed to happen.<o:p></o:p></p></div><div><p class=MsoNormal>Have you done any profiling, like using extended-time for example?<o:p></o:p></p></div><div><p class=MsoNormal><o:p>&nbsp;</o:p></p><div><p class=MsoNormal><br><br><o:p></o:p></p><blockquote style='margin-top:5.0pt;margin-bottom:5.0pt'><div><p class=MsoNormal>On Nov 12, 2020, at 12:29 PM, roy anderson &lt;<a href="mailto:reanz1959@gmail.com">reanz1959@gmail.com</a>&gt; wrote:<o:p></o:p></p></div><p class=MsoNormal><o:p>&nbsp;</o:p></p><div><div><p class=MsoNormal>Calling hcl:gc-generation &nbsp;with generation 3 with the thread below causes frequent medium duration GC calls. Still better than the default periodic “stop the world” GC.<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;<o:p></o:p></p></div><div><p class=MsoNormal>Now testing GC generation 2.<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;<o:p></o:p></p></div><div style='border:none;border-top:solid #E1E1E1 1.0pt;padding:3.0pt 0cm 0cm 0cm'><div><p class=MsoNormal><b>From:<span class=apple-converted-space>&nbsp;</span></b><a href="mailto:vogt@cox.net">cjv</a><br><b>Sent:<span class=apple-converted-space>&nbsp;</span></b>Wednesday, 11 November 2020 4:55 AM<br><b>To:<span class=apple-converted-space>&nbsp;</span></b><a href="mailto:txm.fourier@gmail.com">Alexey Veretennikov</a><br><b>Cc:<span class=apple-converted-space>&nbsp;</span></b><a href="mailto:reanz1959@gmail.com">roy anderson</a>;<span class=apple-converted-space>&nbsp;</span><a href="mailto:lisp-hug@lispworks.com">lisp-hug@lispworks.com</a>;<span class=apple-converted-space>&nbsp;</span><a href="mailto:peter.smyth@xtra.co.nz">Peter Smyth</a><br><b>Subject:<span class=apple-converted-space>&nbsp;</span></b>Re: lispworks garbage collection thread<o:p></o:p></p></div></div><div><p class=MsoNormal>&nbsp;<o:p></o:p></p></div><div><p class=MsoNormal>I concur with Alexey. &nbsp;My experience has been that futzing around with gc parameters is a waste of time. &nbsp;Getting you application to stop consing is where you can really improve gc performance. &nbsp;<o:p></o:p></p></div><div><div><p class=MsoNormal><br><br><br><o:p></o:p></p></div><blockquote style='margin-top:5.0pt;margin-bottom:5.0pt'><div><div><p class=MsoNormal>On Nov 10, 2020, at 12:41 AM, Alexey Veretennikov &lt;<a href="mailto:txm.fourier@gmail.com">txm.fourier@gmail.com</a>&gt; wrote:<o:p></o:p></p></div></div><div><p class=MsoNormal>&nbsp;<o:p></o:p></p></div><div><div><div><div><p class=MsoNormal>Hi,<o:p></o:p></p></div></div><div><div><p class=MsoNormal>&nbsp;<o:p></o:p></p></div></div><div><div><p class=MsoNormal>Maybe one of the potential ways to tackle the problem is to not to generate garbage? I.e. pre-allocate as many objects as needed on startup of the application, use object pools etc.<span class=apple-converted-space>&nbsp;</span><o:p></o:p></p></div></div><div><div><p class=MsoNormal>&nbsp;<o:p></o:p></p></div></div><div><div><p class=MsoNormal>BR,<o:p></o:p></p></div></div><div><div><p class=MsoNormal>/Alexey<o:p></o:p></p></div></div></div><div><p class=MsoNormal>&nbsp;<o:p></o:p></p></div><div><div><div><p class=MsoNormal>On Tue, Nov 10, 2020 at 2:17 AM roy anderson &lt;<a href="mailto:reanz1959@gmail.com">reanz1959@gmail.com</a>&gt; wrote:<o:p></o:p></p></div></div><blockquote style='border:none;border-left:solid #CCCCCC 1.0pt;padding:0cm 0cm 0cm 6.0pt;margin-left:4.8pt;margin-top:5.0pt;margin-right:0cm;margin-bottom:5.0pt'><div><div><div><p class=MsoNormal>We are developing a document analysis application which puts pressure on the LispWorks 64bit Windows Professional garbage collector..<span class=apple-converted-space>&nbsp;</span><o:p></o:p></p></div><p class=MsoNormal>&nbsp;</p><div><p class=MsoNormal>In particular, everything stops for quite a while the gc is working from time to time.<o:p></o:p></p></div><p class=MsoNormal>&nbsp;</p><div><p class=MsoNormal>To reduce the impact of the gc. I am working on the code below to do automated garbage collection after either a certain number of tranactions or a set period..<o:p></o:p></p></div><p class=MsoNormal>&nbsp;</p><div><p class=MsoNormal>This seems to help our situation but are we missing something?<o:p></o:p></p></div><p class=MsoNormal>&nbsp;</p><div><p class=MsoNormal>Here’s our code:<o:p></o:p></p></div><p class=MsoNormal>&nbsp;</p><div><p class=MsoNormal>(defun memory-magnitude (bytes)<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp; (let* ((kb (truncate bytes 1024))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (mb (truncate kb 1024))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (gb (truncate mb 1024))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (tb (truncate gb 1024))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (pb (truncate tb 1024)))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp; (format nil &quot;~{~a~}&quot;<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (cond<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop kb) (list bytes &quot;B&quot;))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop mb) (list kb &quot;KB&quot;))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop gb) (list mb &quot;MB&quot;))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop tb) (list gb &quot;GB&quot;))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop pb) (list tb &quot;TB&quot;))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (t (list pb &quot;PB&quot;))))))<o:p></o:p></p></div><p class=MsoNormal>&nbsp;</p><div><p class=MsoNormal>(defun time-interval (start-transaction)<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp; (let* ((ms (truncate (* 1000 (/ (- (get-internal-real-time) start-transaction)<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; internal-time-units-per-second))))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (s (truncate ms 1000.0))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (min (truncate s 60))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (hours (truncate min 60))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (days (truncate hours 24)))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp; (format nil &quot;~{~a~}&quot;<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (cond<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop s) (list ms &quot;msec&quot;))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((zerop min) (list s &quot;sec&quot;))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop hours) (list min &quot;min&quot;))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop days) (list hours &quot;hours&quot;))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (t (list days &quot;days&quot;))))))<o:p></o:p></p></div><p class=MsoNormal>&nbsp;</p><div><p class=MsoNormal>(defun report-garbage-collection (thread-name actions last-collection)<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp; (let ((room (system:room-values)))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp; (format t &quot;~a[&quot; thread-name)<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp; (unless (zerop actions)<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (format t &quot;~d Action~:p, &quot; actions))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp; (format t &quot;Slept: ~a] Total: ~a Free: ~a~%&quot;<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (time-interval last-collection)<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (memory-magnitude (getf room :TOTAL-SIZE))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (memory-magnitude (getf room :TOTAL-FREE)))))<o:p></o:p></p></div><p class=MsoNormal>&nbsp;</p><div><p class=MsoNormal>(defparameter maximum-sleep-seconds (* 60 5)) ; i.e. 5 minutes<o:p></o:p></p></div><div><p class=MsoNormal>(defparameter transactions 0)<o:p></o:p></p></div><p class=MsoNormal>&nbsp;</p><div><p class=MsoNormal>(defun make-garbage-manager ()<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp; (let ((top-level *standard-output*)<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (thread-name &quot;garbage collector&quot;)<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (last-activity transactions)<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (last-collection (get-internal-real-time))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (slept 0))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp; (flet ((garbage-man ()<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (let ((*standard-output* top-level))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (loop<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while t do<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (sleep 10)<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (incf slept 10)<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (let ((actions (- transactions last-activity)))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (when (or (&gt; actions 5)<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (&gt; slept maximum-sleep-seconds)) ; i.e. more than limit before gc<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (hcl:gc-generation 2)<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (report-garbage-collection thread-name actions last-collection)<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (setf last-collection (get-internal-real-time))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (setf last-activity transactions)<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (setf slept 0)))))))<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (mp:process-run-function thread-name () #'garbage-man))))<span class=apple-converted-space>&nbsp;</span><o:p></o:p></p></div><p class=MsoNormal>&nbsp;</p><div><p class=MsoNormal>(make-garbage-manager)<o:p></o:p></p></div><p class=MsoNormal>&nbsp;</p><div><p class=MsoNormal>Sent from<span class=apple-converted-space>&nbsp;</span><a href="https://go.microsoft.com/fwlink/?LinkId=550986" target="_blank">Mail</a><span class=apple-converted-space>&nbsp;</span>for Windows 10<o:p></o:p></p></div><p class=MsoNormal>&nbsp;<o:p></o:p></p></div></div></blockquote></div></div></blockquote></div><div><p class=MsoNormal>&nbsp;<o:p></o:p></p></div><div><p class=MsoNormal>&nbsp;<o:p></o:p></p></div><p class=MsoNormal><span style='font-size:9.0pt;font-family:"Helvetica",sans-serif'>_______________________________________________ Lisp Hug - the mailing list for LispWorks users<span class=apple-converted-space>&nbsp;</span></span><a href="mailto:lisp-hug@lispworks.com"><span style='font-size:9.0pt;font-family:"Helvetica",sans-serif'>lisp-hug@lispworks.com</span></a><span class=apple-converted-space><span style='font-size:9.0pt;font-family:"Helvetica",sans-serif'>&nbsp;</span></span><a href="http://www.lispworks.com/support/lisp-hug.html"><span style='font-size:9.0pt;font-family:"Helvetica",sans-serif'>http://www.lispworks.com/support/lisp-hug.html</span></a><o:p></o:p></p></div></blockquote></div></div><p class=MsoNormal><o:p>&nbsp;</o:p></p><p class=MsoNormal><o:p>&nbsp;</o:p></p></div></body></html>
_______________________________________________
Lisp Hug - the mailing list for LispWorks users
lisp-hug@lispworks.com
http://www.lispworks.com/support/lisp-hug.html


                </article>
               </section>
               <section class=tree>
                <article class=email>
                 <h1>Re: lispworks garbage collection thread</h1><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; line-break: after-white-space;" class="">You should use the output of ROOM-VALUES to decide whether a GC of generation 3 really is necessary. There’s a cost to calling ROOM-VALUES, too, so it shouldn’t be called too frequently, but there’s no need to run a GC of the blocking generation when there’s not much to collect.<div class=""><br class=""></div><div class="">Espen<br class=""><div><br class=""><blockquote type="cite" class=""><div class="">12. nov. 2020 kl. 21:29 skrev roy anderson &lt;<a href="mailto:reanz1959@gmail.com" class="">reanz1959@gmail.com</a>&gt;:</div><br class="Apple-interchange-newline"><div class=""><div class="WordSection1" style="page: WordSection1; caret-color: rgb(0, 0, 0); font-family: Helvetica; font-size: 12px; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration: none;"><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">Calling hcl:gc-generation &nbsp;with generation 3 with the thread below causes frequent medium duration GC calls. Still better than the default periodic “stop the world” GC.</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class=""><o:p class="">&nbsp;</o:p></div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">Now testing GC generation 2.</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class=""><o:p class="">&nbsp;</o:p></div><div style="border-style: solid none none; border-top-width: 1pt; border-top-color: rgb(225, 225, 225); padding: 3pt 0cm 0cm;" class=""><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif; border: none; padding: 0cm;" class=""><b class="">From:<span class="Apple-converted-space">&nbsp;</span></b><a href="mailto:vogt@cox.net" style="color: blue; text-decoration: underline;" class="">cjv</a><br class=""><b class="">Sent:<span class="Apple-converted-space">&nbsp;</span></b>Wednesday, 11 November 2020 4:55 AM<br class=""><b class="">To:<span class="Apple-converted-space">&nbsp;</span></b><a href="mailto:txm.fourier@gmail.com" style="color: blue; text-decoration: underline;" class="">Alexey Veretennikov</a><br class=""><b class="">Cc:<span class="Apple-converted-space">&nbsp;</span></b><a href="mailto:reanz1959@gmail.com" style="color: blue; text-decoration: underline;" class="">roy anderson</a>;<span class="Apple-converted-space">&nbsp;</span><a href="mailto:lisp-hug@lispworks.com" style="color: blue; text-decoration: underline;" class="">lisp-hug@lispworks.com</a>;<span class="Apple-converted-space">&nbsp;</span><a href="mailto:peter.smyth@xtra.co.nz" style="color: blue; text-decoration: underline;" class="">Peter Smyth</a><br class=""><b class="">Subject:<span class="Apple-converted-space">&nbsp;</span></b>Re: lispworks garbage collection thread</div></div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class=""><o:p class="">&nbsp;</o:p></div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">I concur with Alexey. &nbsp;My experience has been that futzing around with gc parameters is a waste of time. &nbsp;Getting you application to stop consing is where you can really improve gc performance. &nbsp;<o:p class=""></o:p></div><div class=""><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class=""><br class=""><br class=""><o:p class=""></o:p></div><blockquote style="margin-top: 5pt; margin-bottom: 5pt;" class=""><div class=""><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">On Nov 10, 2020, at 12:41 AM, Alexey Veretennikov &lt;<a href="mailto:txm.fourier@gmail.com" style="color: blue; text-decoration: underline;" class="">txm.fourier@gmail.com</a>&gt; wrote:<o:p class=""></o:p></div></div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class=""><o:p class="">&nbsp;</o:p></div><div class=""><div class=""><div class=""><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">Hi,<o:p class=""></o:p></div></div><div class=""><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class=""><o:p class="">&nbsp;</o:p></div></div><div class=""><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">Maybe one of the potential ways to tackle the problem is to not to generate garbage? I.e. pre-allocate as many objects as needed on startup of the application, use object pools etc.<span class="Apple-converted-space">&nbsp;</span><o:p class=""></o:p></div></div><div class=""><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class=""><o:p class="">&nbsp;</o:p></div></div><div class=""><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">BR,<o:p class=""></o:p></div></div><div class=""><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">/Alexey<o:p class=""></o:p></div></div></div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class=""><o:p class="">&nbsp;</o:p></div><div class=""><div class=""><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">On Tue, Nov 10, 2020 at 2:17 AM roy anderson &lt;<a href="mailto:reanz1959@gmail.com" style="color: blue; text-decoration: underline;" class="">reanz1959@gmail.com</a>&gt; wrote:<o:p class=""></o:p></div></div><blockquote style="border-style: none none none solid; border-left-width: 1pt; border-left-color: rgb(204, 204, 204); padding: 0cm 0cm 0cm 6pt; margin-left: 4.8pt; margin-right: 0cm;" class=""><div class=""><div class=""><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">We are developing a document analysis application which puts pressure on the LispWorks 64bit Windows Professional garbage collector.<span class="Apple-converted-space">&nbsp;</span></div><p class="MsoNormal" style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;">&nbsp;</p><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">In particular, everything stops for quite a while the gc is working from time to time.</div><p class="MsoNormal" style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;">&nbsp;</p><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">To reduce the impact of the gc. I am working on the code below to do automated garbage collection after either a certain number of tranactions or a set period.</div><p class="MsoNormal" style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;">&nbsp;</p><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">This seems to help our situation but are we missing something?</div><p class="MsoNormal" style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;">&nbsp;</p><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">Here’s our code:</div><p class="MsoNormal" style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;">&nbsp;</p><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">(defun memory-magnitude (bytes)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp; (let* ((kb (truncate bytes 1024))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (mb (truncate kb 1024))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (gb (truncate mb 1024))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (tb (truncate gb 1024))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (pb (truncate tb 1024)))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp; (format nil "~{~a~}"</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (cond</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop kb) (list bytes "B"))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop mb) (list kb "KB"))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop gb) (list mb "MB"))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop tb) (list gb "GB"))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop pb) (list tb "TB"))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (t (list pb "PB"))))))</div><p class="MsoNormal" style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;">&nbsp;</p><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">(defun time-interval (start-transaction)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp; (let* ((ms (truncate (* 1000 (/ (- (get-internal-real-time) start-transaction)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; internal-time-units-per-second))))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (s (truncate ms 1000.0))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (min (truncate s 60))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (hours (truncate min 60))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (days (truncate hours 24)))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp; (format nil "~{~a~}"</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (cond</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop s) (list ms "msec"))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((zerop min) (list s "sec"))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop hours) (list min "min"))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((zerop days) (list hours "hours"))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (t (list days "days"))))))</div><p class="MsoNormal" style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;">&nbsp;</p><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">(defun report-garbage-collection (thread-name actions last-collection)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp; (let ((room (system:room-values)))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp; (format t "~a[" thread-name)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp; (unless (zerop actions)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (format t "~d Action~:p, " actions))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp; (format t "Slept: ~a] Total: ~a Free: ~a~%"</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (time-interval last-collection)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (memory-magnitude (getf room :TOTAL-SIZE))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (memory-magnitude (getf room :TOTAL-FREE)))))</div><p class="MsoNormal" style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;">&nbsp;</p><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">(defparameter maximum-sleep-seconds (* 60 5)) ; i.e. 5 minutes</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">(defparameter transactions 0)</div><p class="MsoNormal" style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;">&nbsp;</p><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">(defun make-garbage-manager ()</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp; (let ((top-level *standard-output*)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (thread-name "garbage collector")</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (last-activity transactions)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (last-collection (get-internal-real-time))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (slept 0))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp; (flet ((garbage-man ()</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (let ((*standard-output* top-level))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (loop</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while t do</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (sleep 10)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (incf slept 10)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (let ((actions (- transactions last-activity)))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (when (or (&gt; actions 5)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (&gt; slept maximum-sleep-seconds)) ; i.e. more than limit before gc</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (hcl:gc-generation 2)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (report-garbage-collection thread-name actions last-collection)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (setf last-collection (get-internal-real-time))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (setf last-activity transactions)</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (setf slept 0)))))))</div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (mp:process-run-function thread-name () #'garbage-man))))<span class="Apple-converted-space">&nbsp;</span></div><p class="MsoNormal" style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;">&nbsp;</p><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">(make-garbage-manager)</div><p class="MsoNormal" style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;">&nbsp;</p><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class="">Sent from<span class="Apple-converted-space">&nbsp;</span><a href="https://go.microsoft.com/fwlink/?LinkId=550986" target="_blank" style="color: blue; text-decoration: underline;" class="">Mail</a><span class="Apple-converted-space">&nbsp;</span>for Windows 10</div><p class="MsoNormal" style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;">&nbsp;</p></div></div></blockquote></div></div></blockquote></div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class=""><o:p class="">&nbsp;</o:p></div><div style="margin: 0cm; font-size: 11pt; font-family: Calibri, sans-serif;" class=""><o:p class="">&nbsp;</o:p></div></div><span style="caret-color: rgb(0, 0, 0); font-family: Helvetica; font-size: 12px; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration: none; float: none; display: inline !important;" class="">_______________________________________________ Lisp Hug - the mailing list for LispWorks users<span class="Apple-converted-space">&nbsp;</span></span><a href="mailto:lisp-hug@lispworks.com" style="color: blue; text-decoration: underline; font-family: Helvetica; font-size: 12px; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;" class="">lisp-hug@lispworks.com</a><span style="caret-color: rgb(0, 0, 0); font-family: Helvetica; font-size: 12px; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration: none; float: none; display: inline !important;" class=""></span><a href="http://www.lispworks.com/support/lisp-hug.html" style="color: blue; text-decoration: underline; font-family: Helvetica; font-size: 12px; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: auto; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;" class="">http://www.lispworks.com/support/lisp-hug.html</a><span style="caret-color: rgb(0, 0, 0); font-family: Helvetica; font-size: 12px; font-style: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-stroke-width: 0px; text-decoration: none; float: none; display: inline !important;" class=""></span></div></blockquote></div><br class=""></div></body></html>

                </article>
               </section>
              </section>
             </div>
            </div>
            <footer class="d-flex justify-content-center">
             <div>
              Updated at: 2020-12-10 08:28 UTC
             </div>
            </footer>
           </body>
          </html>