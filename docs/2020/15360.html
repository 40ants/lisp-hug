<!DOCTYPE html>
<html lang=en>
           <head>
            <meta charset=UTF-8>
            <title>Tail Call Optimization</title>
            <meta name=viewport
                  content="width=device-width, initial-scale=1.0">
            <link rel=stylesheet
                  href=https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css
                  integrity=sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2
                  crossorigin=anonymous>
            <style>
section.tree {
    padding-left: 2em;
}
section.tree:first-child {
    padding-left: 0;
}
.article-link {
  margin-bottom: 1em;
}
</style>
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9X3G9MMWZP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-9X3G9MMWZP');
</script>

           </head>
           <body>
            <header class="d-flex justify-content-center">
             <nav
                  class="navbar navbar-light bg-light w-100 mx-5 mb-3">
              <a class=navbar-brand href="/">Lisp HUG Maillist Archive</a>
             </nav>
            </header>
            <div class="d-flex justify-content-center">
             <div class="w-100 mx-5 px-3">
              <section class=tree>
               <article class=email>
                <h1>Tail Call Optimization</h1><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; line-break: after-white-space;" class="">I know that LW can optimize tail calls in many cases. I have seen it many times. But being able to predict when it can occur is next to impossible.<div class=""><br class=""></div><div class="">I have instances where the tail call is through a captured closure stored in a local binding, or in one of the bindings of the closure of the current function. And in those cases it seems that LW refuses to perform a tail call through that pointer, no matter how I declare the optimization to the compiler. There is only a single value that I’m passing to the captured closure, so it isn’t a question of too many args, or keyword args, etc., interfering.</div><div class=""><br class=""></div><div class="">So it seems that compiler declarations are a weak method of invoking what you want, when you absolutely know you should be getting tail calls. Why not implement a Lisp primitive that directly performs a tail call, i.e., JMP with args?</div><div class=""><br class=""></div><div class="">(Stupid) Example that blows the stack:</div><div class=""><br class=""></div><div class=""><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(let ((sav-k #'values)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; (sav-n 500))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (block myblock</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; (tagbody top</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(let ((k sav-k)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(n sav-n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(return-from myblock</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(if (&lt; n 2)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(funcall k 1)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(let ((k (let ((k k) &nbsp;;; form our own captures just to be certain...</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (n n)) ;; should not be necessary here</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (lambda (t1)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (funcall k (* t1 n))))))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(setf sav-k k</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sav-n (1- n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(go top))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;))))))</span></font></div></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">- David McClain</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">Refined Audiometrics Laboratory</span></font></div><div class=""><font face="Monaco" class=""><a href="http://refined-audiometrics.com" class="">refined-audiometrics.com</a></font></div><div class=""><font face="Monaco" class="">Tucson, AZ, USA</font></div></body></html>

               </article>
               <section class=tree>
                <article class=email>
                 <h1>Re: Tail Call Optimization</h1><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; line-break: after-white-space;" class="">Here is what I managed to come up with. It no longer blows the stack. But the runtime is likely suffering a bit, compared to what a direct tail-call could provide...<div class=""><br class=""></div><div class=""><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(define-condition values-signal ()</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; ((args &nbsp;:reader values-signal-args :initarg :args)))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(defun retk (&amp;rest args)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (error (make-condition 'values-signal :args args)))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(defun fwdk (c)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (apply 'funcall (values-signal-args c)))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div></div><div class=""><div class=""><div class=""><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(let ((sav-k #'values)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; (sav-n 5000))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (block myblock</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; (tagbody top</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(let ((k sav-k)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(n sav-n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(return-from myblock</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<font color="#ff225e" class="">(handler-case</font></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(if (&lt; n 2)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(<font color="#ff225e" class="">retk</font> k 1) ;; instead of funcall</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(let ((k (lambda (t1)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<font color="#ff225e" class="">retk</font> k (* n t1)))))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(setf sav-k k</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sav-n (1- n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(go top)))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <font color="#ff225e" class="">&nbsp;(values-signal (c)</font></span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(block hndlr-block</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(tagbody again</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (handler-case</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (return-from hndlr-block</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (fwdk c))</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (values-signal (cnew)</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (setf c cnew)</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (go again))))))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;))))))</span></font></div></div></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">- David McClain</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">Refined Audiometrics Laboratory</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><a href="http://refined-audiometrics.com" class="">refined-audiometrics.com</a></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">Tucson, AZ, USA</span></font></div><div><br class=""><blockquote type="cite" class=""><div class="">On Oct 3, 2020, at 11:43 AM, <a href="mailto:dbm@refined-audiometrics.com" class="">dbm@refined-audiometrics.com</a> wrote:</div><br class="Apple-interchange-newline"><div class=""><meta http-equiv="Content-Type" content="text/html; charset=utf-8" class=""><div style="word-wrap: break-word; -webkit-nbsp-mode: space; line-break: after-white-space;" class="">I know that LW can optimize tail calls in many cases. I have seen it many times. But being able to predict when it can occur is next to impossible.<div class=""><br class=""></div><div class="">I have instances where the tail call is through a captured closure stored in a local binding, or in one of the bindings of the closure of the current function. And in those cases it seems that LW refuses to perform a tail call through that pointer, no matter how I declare the optimization to the compiler. There is only a single value that I’m passing to the captured closure, so it isn’t a question of too many args, or keyword args, etc., interfering.</div><div class=""><br class=""></div><div class="">So it seems that compiler declarations are a weak method of invoking what you want, when you absolutely know you should be getting tail calls. Why not implement a Lisp primitive that directly performs a tail call, i.e., JMP with args?</div><div class=""><br class=""></div><div class="">(Stupid) Example that blows the stack:</div><div class=""><br class=""></div><div class=""><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(let ((sav-k #'values)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; (sav-n 500))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (block myblock</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; (tagbody top</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(let ((k sav-k)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(n sav-n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(return-from myblock</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(if (&lt; n 2)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(funcall k 1)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(let ((k (let ((k k) &nbsp;;; form our own captures just to be certain...</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (n n)) ;; should not be necessary here</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (lambda (t1)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (funcall k (* t1 n))))))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(setf sav-k k</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sav-n (1- n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(go top))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;))))))</span></font></div></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">- David McClain</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">Refined Audiometrics Laboratory</span></font></div><div class=""><font face="Monaco" class=""><a href="http://refined-audiometrics.com/" class="">refined-audiometrics.com</a></font></div><div class=""><font face="Monaco" class="">Tucson, AZ, USA</font></div></div></div></blockquote></div><br class=""></div></body></html>

                </article>
                <section class=tree>
                 <article class=email>
                  <h1>Re: Tail Call Optimization</h1><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"></head><body dir="auto"><div dir="ltr">A long time ago, I wrote a version of named let fir CL. &nbsp;It had to run on Genera, which did not optimise tail calls, at all. &nbsp;So on genera it turned the tail call into a GO. &nbsp;And I thought I was very clever. &nbsp;But now it was this stupid fragile thing since it also turned non-tail calls into GOs of course, and broke everything.</div><div dir="ltr"><br></div><div dir="ltr">I never used my clever hack after the first time it blew up in my face.</div><div dir="ltr"><br></div><div dir="ltr">The solution to an implementation not optimising tail calls when you want it to is one of two things, I think:</div><div dir="ltr"><br></div><div dir="ltr">- rewrite the loops as loops, perhaps with some macro which helps you express the loops you want better;</div><div dir="ltr">- and/or persuade the people who look after the implementation that this is a case where it should be optimising the tail call away.</div><div dir="ltr"><br></div><div dir="ltr">--tim</div><div dir="ltr"><br><blockquote type="cite">On 4 Oct 2020, at 02:21, dbm@refined-audiometrics.com wrote:<br><br></blockquote></div><blockquote type="cite"><div dir="ltr">﻿<meta http-equiv="Content-Type" content="text/html; charset=utf-8">Here is what I managed to come up with. It no longer blows the stack. But the runtime is likely suffering a bit, compared to what a direct tail-call could provide...<div class=""><br class=""></div><div class=""><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(define-condition values-signal ()</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; ((args &nbsp;:reader values-signal-args :initarg :args)))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(defun retk (&amp;rest args)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (error (make-condition 'values-signal :args args)))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(defun fwdk (c)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (apply 'funcall (values-signal-args c)))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div></div><div class=""><div class=""><div class=""><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(let ((sav-k #'values)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; (sav-n 5000))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (block myblock</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; (tagbody top</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(let ((k sav-k)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(n sav-n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(return-from myblock</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<font color="#ff225e" class="">(handler-case</font></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(if (&lt; n 2)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(<font color="#ff225e" class="">retk</font> k 1) ;; instead of funcall</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(let ((k (lambda (t1)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<font color="#ff225e" class="">retk</font> k (* n t1)))))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(setf sav-k k</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sav-n (1- n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(go top)))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <font color="#ff225e" class="">&nbsp;(values-signal (c)</font></span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(block hndlr-block</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(tagbody again</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (handler-case</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (return-from hndlr-block</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (fwdk c))</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (values-signal (cnew)</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (setf c cnew)</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (go again))))))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;))))))</span></font></div></div></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">- David McClain</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">Refined Audiometrics Laboratory</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><a href="http://refined-audiometrics.com" class="">refined-audiometrics.com</a></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">Tucson, AZ, USA</span></font></div><div><br class=""><blockquote type="cite" class=""><div class="">On Oct 3, 2020, at 11:43 AM, <a href="mailto:dbm@refined-audiometrics.com" class="">dbm@refined-audiometrics.com</a> wrote:</div><br class="Apple-interchange-newline"><div class=""><meta http-equiv="Content-Type" content="text/html; charset=utf-8" class=""><div style="word-wrap: break-word; -webkit-nbsp-mode: space; line-break: after-white-space;" class="">I know that LW can optimize tail calls in many cases. I have seen it many times. But being able to predict when it can occur is next to impossible.<div class=""><br class=""></div><div class="">I have instances where the tail call is through a captured closure stored in a local binding, or in one of the bindings of the closure of the current function. And in those cases it seems that LW refuses to perform a tail call through that pointer, no matter how I declare the optimization to the compiler. There is only a single value that I’m passing to the captured closure, so it isn’t a question of too many args, or keyword args, etc., interfering.</div><div class=""><br class=""></div><div class="">So it seems that compiler declarations are a weak method of invoking what you want, when you absolutely know you should be getting tail calls. Why not implement a Lisp primitive that directly performs a tail call, i.e., JMP with args?</div><div class=""><br class=""></div><div class="">(Stupid) Example that blows the stack:</div><div class=""><br class=""></div><div class=""><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(let ((sav-k #'values)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; (sav-n 500))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (block myblock</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; (tagbody top</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(let ((k sav-k)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(n sav-n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(return-from myblock</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(if (&lt; n 2)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(funcall k 1)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(let ((k (let ((k k) &nbsp;;; form our own captures just to be certain...</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (n n)) ;; should not be necessary here</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (lambda (t1)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (funcall k (* t1 n))))))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(setf sav-k k</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sav-n (1- n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(go top))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;))))))</span></font></div></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">- David McClain</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">Refined Audiometrics Laboratory</span></font></div><div class=""><font face="Monaco" class=""><a href="http://refined-audiometrics.com/" class="">refined-audiometrics.com</a></font></div><div class=""><font face="Monaco" class="">Tucson, AZ, USA</font></div></div></div></blockquote></div><br class=""></div></div></blockquote></body></html>

                 </article>
                </section>
                <section class=tree>
                 <article class=email>
                  <h1>Re: Tail Call Optimization</h1>
                  <pre>The documentation is quite vague. It turns out, after some experiments on this end, that the presence of either &amp;KEY or &amp;REST args destroys the ability to provide TCO. The use of &amp;OPTIONAL seem to be okay, including those with init forms, and there seems no practical limit on them, nor on the number of simple args, for X86.

The use of GO is not quite appropriate in many cases, since the continuation closures are often coming from unknown and arbitrary places. A GO requires a known tag.

It turns out that the restriction to avoid &amp;REST is qutie severe in many cases, as it prevents the easy construction of more general purpose macros. I suppose something could be cobbled together using a long list of &amp;OPTIONAL args.

- DM


_______________________________________________
Lisp Hug - the mailing list for LispWorks users
lisp-hug@lispworks.com
http://www.lispworks.com/support/lisp-hug.html

</pre>
                 </article>
                </section>
                <section class=tree>
                 <article class=email>
                  <h1>Re: Tail Call Optimization</h1>
                  <pre>It turns out that, while a “proper implementation” would have the continuation calls be terminal, in Lisp they aren’t and you can have activity following that continuation call.

Lisp shares some programming traits in common with my old Forth languages - in that as long as you write things properly, then things will work. Lisp also leaves things out in the open for access by “constrained adults”, whereas other languages seek to hide through encapsulation. On the whole, I think I prefer the Lisp way.



&gt On Oct 4, 2020, at 2:18 AM, dbm@refined-audiometrics.com wrote:
&gt 
&gt The documentation is quite vague. It turns out, after some experiments on this end, that the presence of either &amp;KEY or &amp;REST args destroys the ability to provide TCO. The use of &amp;OPTIONAL seem to be okay, including those with init forms, and there seems no practical limit on them, nor on the number of simple args, for X86.
&gt 
&gt The use of GO is not quite appropriate in many cases, since the continuation closures are often coming from unknown and arbitrary places. A GO requires a known tag.
&gt 
&gt It turns out that the restriction to avoid &amp;REST is qutie severe in many cases, as it prevents the easy construction of more general purpose macros. I suppose something could be cobbled together using a long list of &amp;OPTIONAL args.
&gt 
&gt - DM
&gt 
&gt 
&gt _______________________________________________
&gt Lisp Hug - the mailing list for LispWorks users
&gt lisp-hug@lispworks.com
&gt http://www.lispworks.com/support/lisp-hug.html


_______________________________________________
Lisp Hug - the mailing list for LispWorks users
lisp-hug@lispworks.com
http://www.lispworks.com/support/lisp-hug.html

</pre>
                 </article>
                </section>
                <section class=tree>
                 <article class=email>
                  <h1>Re: Tail Call Optimization</h1>
                  <pre>So, in summary,

1. The original code actually runs fine once compiled. 

2. No need for the HANDLER-CASE to consolidate continuation calls at one stack level (you can do, but then it causes problems if the continuation is picked up in another thread from where it was constructed)

3. TCO works just fine, nice and speedy, compared to HANDLER-CASE, so long as you avoid continuation closures that accept &amp;KEY or &amp;REST args.

I thought I was faithfully showing my complaint case in the original code, but alas my macros inserted &amp;REST args that I did not faithfully carry over to the stupid example code. However, in contrast to the documentation, the stupid example contains nothing with dynamic scope, and so the documentation would have us believe that TCO will work there. It does, in the code that I showed, but it didn’t in my macrology becauase of the &amp;REST args.

It would still be nice to have a forced, terminating, GoTo indirect, with args… I can do that in Assembly language, so why should Lisp be hobbled?

- DM

&gt On Oct 4, 2020, at 2:23 AM, dbm@refined-audiometrics.com wrote:
&gt 
&gt It turns out that, while a “proper implementation” would have the continuation calls be terminal, in Lisp they aren’t and you can have activity following that continuation call.
&gt 
&gt Lisp shares some programming traits in common with my old Forth languages - in that as long as you write things properly, then things will work. Lisp also leaves things out in the open for access by “constrained adults”, whereas other languages seek to hide through encapsulation. On the whole, I think I prefer the Lisp way.
&gt 
&gt 
&gt 
&gt&gt On Oct 4, 2020, at 2:18 AM, dbm@refined-audiometrics.com wrote:
&gt&gt 
&gt&gt The documentation is quite vague. It turns out, after some experiments on this end, that the presence of either &amp;KEY or &amp;REST args destroys the ability to provide TCO. The use of &amp;OPTIONAL seem to be okay, including those with init forms, and there seems no practical limit on them, nor on the number of simple args, for X86.
&gt&gt 
&gt&gt The use of GO is not quite appropriate in many cases, since the continuation closures are often coming from unknown and arbitrary places. A GO requires a known tag.
&gt&gt 
&gt&gt It turns out that the restriction to avoid &amp;REST is qutie severe in many cases, as it prevents the easy construction of more general purpose macros. I suppose something could be cobbled together using a long list of &amp;OPTIONAL args.
&gt&gt 
&gt&gt - DM
&gt&gt 
&gt&gt 
&gt&gt _______________________________________________
&gt&gt Lisp Hug - the mailing list for LispWorks users
&gt&gt lisp-hug@lispworks.com
&gt&gt http://www.lispworks.com/support/lisp-hug.html
&gt 
&gt 
&gt _______________________________________________
&gt Lisp Hug - the mailing list for LispWorks users
&gt lisp-hug@lispworks.com
&gt http://www.lispworks.com/support/lisp-hug.html


_______________________________________________
Lisp Hug - the mailing list for LispWorks users
lisp-hug@lispworks.com
http://www.lispworks.com/support/lisp-hug.html

</pre>
                 </article>
                </section>
                <section class=tree>
                 <article class=email>
                  <h1>Re: Tail Call Optimization</h1>
                  <pre>As for the Named Let example code, that NLET-TAIL is to be used only when you now you will recurse from tail position. 

And the whole point of my exercise was to take something with non-tail recursion and force it into tail recursion by using continuations. It works. For non-tail recursion I have NLET, which also happens to perform TCO when used in tail-recursive situations, so long as you avoid &amp;KEY and &amp;REST args in the function. 

But NLET will not turn anything into a GO, while NLET-TAIL always does.

There is no need to be ruled by the LOOP…

- DM



_______________________________________________
Lisp Hug - the mailing list for LispWorks users
lisp-hug@lispworks.com
http://www.lispworks.com/support/lisp-hug.html

</pre>
                 </article>
                </section>
               </section>
               <section class=tree>
                <article class=email>
                 <h1>Re: Tail Call Optimization</h1><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; line-break: after-white-space;" class="">… and with suitable macrology, this condenses nicely into:<div class=""><br class=""></div><div class=""><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(=nlet-tail fact ((n 500))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (if (&lt; n 2)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; (=values 1)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; (=bind (t1)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; (fact (1- n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; (=values (* n t1)))))</span></font></div><div class=""><br class=""></div><div><div class="" style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0);"><font face="Monaco" class="">- David McClain</font></div><div class="" style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0);"><font face="Monaco" class="">Refined Audiometrics Laboratory</font></div><div class="" style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0);"><font face="Monaco" class=""><span class=""><a href="http://refined-audiometrics.com" class="">refined-audiometrics.com</a></span></font></div><div class="" style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0);"><font face="Monaco" class="">Tucson, AZ, USA</font></div><div class="" style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0);"><font face="Monaco" class=""><br class=""></font></div><div class="" style="caret-color: rgb(0, 0, 0); color: rgb(0, 0, 0);"><font face="Monaco" class=""><br class=""></font></div></div><div><blockquote type="cite" class=""><div class="">On Oct 3, 2020, at 6:18 PM, <a href="mailto:dbm@refined-audiometrics.com" class="">dbm@refined-audiometrics.com</a> wrote:</div><br class="Apple-interchange-newline"><div class=""><meta http-equiv="Content-Type" content="text/html; charset=utf-8" class=""><div style="word-wrap: break-word; -webkit-nbsp-mode: space; line-break: after-white-space;" class="">Here is what I managed to come up with. It no longer blows the stack. But the runtime is likely suffering a bit, compared to what a direct tail-call could provide...<div class=""><br class=""></div><div class=""><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(define-condition values-signal ()</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; ((args &nbsp;:reader values-signal-args :initarg :args)))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(defun retk (&amp;rest args)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (error (make-condition 'values-signal :args args)))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(defun fwdk (c)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (apply 'funcall (values-signal-args c)))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div></div><div class=""><div class=""><div class=""><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(let ((sav-k #'values)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; (sav-n 5000))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (block myblock</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; (tagbody top</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(let ((k sav-k)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(n sav-n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(return-from myblock</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<font color="#ff225e" class="">(handler-case</font></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(if (&lt; n 2)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(<font color="#ff225e" class="">retk</font> k 1) ;; instead of funcall</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(let ((k (lambda (t1)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<font color="#ff225e" class="">retk</font> k (* n t1)))))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(setf sav-k k</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sav-n (1- n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(go top)))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <font color="#ff225e" class="">&nbsp;(values-signal (c)</font></span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(block hndlr-block</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(tagbody again</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (handler-case</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (return-from hndlr-block</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (fwdk c))</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (values-signal (cnew)</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (setf c cnew)</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (go again))))))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;))))))</span></font></div></div></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">- David McClain</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">Refined Audiometrics Laboratory</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><a href="http://refined-audiometrics.com/" class="">refined-audiometrics.com</a></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">Tucson, AZ, USA</span></font></div><div class=""><br class=""><blockquote type="cite" class=""><div class="">On Oct 3, 2020, at 11:43 AM, <a href="mailto:dbm@refined-audiometrics.com" class="">dbm@refined-audiometrics.com</a> wrote:</div><br class="Apple-interchange-newline"><div class=""><meta http-equiv="Content-Type" content="text/html; charset=utf-8" class=""><div style="word-wrap: break-word; -webkit-nbsp-mode: space; line-break: after-white-space;" class="">I know that LW can optimize tail calls in many cases. I have seen it many times. But being able to predict when it can occur is next to impossible.<div class=""><br class=""></div><div class="">I have instances where the tail call is through a captured closure stored in a local binding, or in one of the bindings of the closure of the current function. And in those cases it seems that LW refuses to perform a tail call through that pointer, no matter how I declare the optimization to the compiler. There is only a single value that I’m passing to the captured closure, so it isn’t a question of too many args, or keyword args, etc., interfering.</div><div class=""><br class=""></div><div class="">So it seems that compiler declarations are a weak method of invoking what you want, when you absolutely know you should be getting tail calls. Why not implement a Lisp primitive that directly performs a tail call, i.e., JMP with args?</div><div class=""><br class=""></div><div class="">(Stupid) Example that blows the stack:</div><div class=""><br class=""></div><div class=""><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(let ((sav-k #'values)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; (sav-n 500))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (block myblock</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; (tagbody top</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(let ((k sav-k)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(n sav-n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(return-from myblock</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(if (&lt; n 2)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(funcall k 1)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(let ((k (let ((k k) &nbsp;;; form our own captures just to be certain...</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (n n)) ;; should not be necessary here</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (lambda (t1)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (funcall k (* t1 n))))))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(setf sav-k k</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sav-n (1- n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(go top))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;))))))</span></font></div></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">- David McClain</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">Refined Audiometrics Laboratory</span></font></div><div class=""><font face="Monaco" class=""><a href="http://refined-audiometrics.com/" class="">refined-audiometrics.com</a></font></div><div class=""><font face="Monaco" class="">Tucson, AZ, USA</font></div></div></div></blockquote></div><br class=""></div></div></div></blockquote></div><br class=""></div></body></html>

                </article>
               </section>
               <section class=tree>
                <article class=email>
                 <h1>Re: Tail Call Optimization</h1><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; line-break: after-white-space;" class="">I FOUND IT!&nbsp;<div class=""><br class=""></div><div class="">As long as you call a Lambda function with simple arguments as the captured continuation, the tail forwarding calls work with TCO. My original macros were expanding the arguments lists so that a function like this:</div><div class=""><br class=""></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(lambda (x) ...)</span></font></div><div class=""><br class=""></div><div class="">were actually expanded to this:</div><div class=""><br class=""></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(lambda (&amp;optional x &amp;rest ignored) ... )</span></font></div><div class=""><br class=""></div><div class="">And that seemingly simple alteration is all that was needed to prevent the TCO inside the Lambda closure.</div><div class=""><br class=""></div><div class="">- DM<br class=""><div><br class=""><blockquote type="cite" class=""><div class="">On Oct 3, 2020, at 6:22 PM, <a href="mailto:dbm@refined-audiometrics.com" class="">dbm@refined-audiometrics.com</a> wrote:</div><br class="Apple-interchange-newline"><div class=""><meta http-equiv="Content-Type" content="text/html; charset=utf-8" class=""><div style="word-wrap: break-word; -webkit-nbsp-mode: space; line-break: after-white-space;" class="">… and with suitable macrology, this condenses nicely into:<div class=""><br class=""></div><div class=""><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(=nlet-tail fact ((n 500))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (if (&lt; n 2)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; (=values 1)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; (=bind (t1)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; (fact (1- n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; (=values (* n t1)))))</span></font></div><div class=""><br class=""></div><div class=""><div class="" style="caret-color: rgb(0, 0, 0);"><font face="Monaco" class="">- David McClain</font></div><div class="" style="caret-color: rgb(0, 0, 0);"><font face="Monaco" class="">Refined Audiometrics Laboratory</font></div><div class="" style="caret-color: rgb(0, 0, 0);"><font face="Monaco" class=""><span class=""><a href="http://refined-audiometrics.com/" class="">refined-audiometrics.com</a></span></font></div><div class="" style="caret-color: rgb(0, 0, 0);"><font face="Monaco" class="">Tucson, AZ, USA</font></div><div class="" style="caret-color: rgb(0, 0, 0);"><font face="Monaco" class=""><br class=""></font></div><div class="" style="caret-color: rgb(0, 0, 0);"><font face="Monaco" class=""><br class=""></font></div></div><div class=""><blockquote type="cite" class=""><div class="">On Oct 3, 2020, at 6:18 PM, <a href="mailto:dbm@refined-audiometrics.com" class="">dbm@refined-audiometrics.com</a> wrote:</div><br class="Apple-interchange-newline"><div class=""><meta http-equiv="Content-Type" content="text/html; charset=utf-8" class=""><div style="word-wrap: break-word; -webkit-nbsp-mode: space; line-break: after-white-space;" class="">Here is what I managed to come up with. It no longer blows the stack. But the runtime is likely suffering a bit, compared to what a direct tail-call could provide...<div class=""><br class=""></div><div class=""><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(define-condition values-signal ()</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; ((args &nbsp;:reader values-signal-args :initarg :args)))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(defun retk (&amp;rest args)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (error (make-condition 'values-signal :args args)))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(defun fwdk (c)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (apply 'funcall (values-signal-args c)))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div></div><div class=""><div class=""><div class=""><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(let ((sav-k #'values)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; (sav-n 5000))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (block myblock</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; (tagbody top</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(let ((k sav-k)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(n sav-n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(return-from myblock</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<font color="#ff225e" class="">(handler-case</font></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(if (&lt; n 2)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(<font color="#ff225e" class="">retk</font> k 1) ;; instead of funcall</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(let ((k (lambda (t1)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<font color="#ff225e" class="">retk</font> k (* n t1)))))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(setf sav-k k</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sav-n (1- n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(go top)))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <font color="#ff225e" class="">&nbsp;(values-signal (c)</font></span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(block hndlr-block</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(tagbody again</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (handler-case</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (return-from hndlr-block</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (fwdk c))</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (values-signal (cnew)</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (setf c cnew)</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (go again))))))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;))))))</span></font></div></div></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">- David McClain</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">Refined Audiometrics Laboratory</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><a href="http://refined-audiometrics.com/" class="">refined-audiometrics.com</a></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">Tucson, AZ, USA</span></font></div><div class=""><br class=""><blockquote type="cite" class=""><div class="">On Oct 3, 2020, at 11:43 AM, <a href="mailto:dbm@refined-audiometrics.com" class="">dbm@refined-audiometrics.com</a> wrote:</div><br class="Apple-interchange-newline"><div class=""><meta http-equiv="Content-Type" content="text/html; charset=utf-8" class=""><div style="word-wrap: break-word; -webkit-nbsp-mode: space; line-break: after-white-space;" class="">I know that LW can optimize tail calls in many cases. I have seen it many times. But being able to predict when it can occur is next to impossible.<div class=""><br class=""></div><div class="">I have instances where the tail call is through a captured closure stored in a local binding, or in one of the bindings of the closure of the current function. And in those cases it seems that LW refuses to perform a tail call through that pointer, no matter how I declare the optimization to the compiler. There is only a single value that I’m passing to the captured closure, so it isn’t a question of too many args, or keyword args, etc., interfering.</div><div class=""><br class=""></div><div class="">So it seems that compiler declarations are a weak method of invoking what you want, when you absolutely know you should be getting tail calls. Why not implement a Lisp primitive that directly performs a tail call, i.e., JMP with args?</div><div class=""><br class=""></div><div class="">(Stupid) Example that blows the stack:</div><div class=""><br class=""></div><div class=""><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(let ((sav-k #'values)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; (sav-n 500))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (block myblock</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; (tagbody top</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(let ((k sav-k)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(n sav-n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(return-from myblock</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(if (&lt; n 2)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(funcall k 1)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(let ((k (let ((k k) &nbsp;;; form our own captures just to be certain...</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (n n)) ;; should not be necessary here</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (lambda (t1)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (funcall k (* t1 n))))))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(setf sav-k k</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sav-n (1- n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(go top))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;))))))</span></font></div></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">- David McClain</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">Refined Audiometrics Laboratory</span></font></div><div class=""><font face="Monaco" class=""><a href="http://refined-audiometrics.com/" class="">refined-audiometrics.com</a></font></div><div class=""><font face="Monaco" class="">Tucson, AZ, USA</font></div></div></div></blockquote></div><br class=""></div></div></div></blockquote></div><br class=""></div></div></div></blockquote></div><br class=""></div></body></html>

                </article>
               </section>
               <section class=tree>
                <article class=email>
                 <h1>Re: Tail Call Optimization</h1><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; line-break: after-white-space;" class=""><a href="http://www.lispworks.com/documentation/lw71/LW/html/lw-66.htm#pgfId-887598" class="">http://www.lispworks.com/documentation/lw71/LW/html/lw-66.htm#pgfId-887598</a><div class=""><br class=""></div><div class="">the documentation says:</div><div class=""><br class=""></div><div class=""><br class=""></div><div class=""><div class=""><p class="Body" style="text-indent: 0pt; margin: 6pt 0pt 0pt; font-size: 11pt; vertical-align: baseline; font-family: Palatino, &quot;Palatino Linotype&quot;, serif;">In 64-bit LispWorks and on x86 platforms the compiler optimizes tail calls unless</p><ol class=""><li class="Step-1" style="text-align: left; text-indent: 0pt; margin: 6pt 0pt 0pt; font-size: 11pt; vertical-align: baseline; font-family: Palatino, &quot;Palatino Linotype&quot;, serif;"><a name="pgfId-889236" class=""></a>The compiler optimize quality&nbsp;<code class="Code" style="font-size: 10pt; font-weight: bold; vertical-align: baseline; font-family: Courier, monospace;">debug</code>&nbsp;is 3, or</li><li class="Step" style="text-align: left; text-indent: 0pt; margin: 6pt 0pt 0pt; font-size: 11pt; vertical-align: baseline; font-family: Palatino, &quot;Palatino Linotype&quot;, serif;"><a name="pgfId-889238" class=""></a>There is something with dynamic scope on the stack, such as a special binding, a catch or&nbsp;<code class="Code" style="font-size: 10pt; font-weight: bold; vertical-align: baseline; font-family: Courier, monospace;">cl:dynamic-extent</code>&nbsp;allocation (so it is not really a tail call)</li><p class="Body" style="text-indent: 0pt; margin: 6pt 0pt 0pt; font-size: 11pt; vertical-align: baseline; font-family: Palatino, &quot;Palatino Linotype&quot;, serif;"><a name="pgfId-889242" class=""></a>On all other platforms the compiler optimizes tail calls unless 1.) or 2.) above apply, or</p><li class="Step" style="text-align: left; text-indent: 0pt; margin: 6pt 0pt 0pt; font-size: 11pt; vertical-align: baseline; font-family: Palatino, &quot;Palatino Linotype&quot;, serif;"><a name="pgfId-889245" class=""></a>The call has more than 4 arguments and this is more than the number of fixed (not&nbsp;<code class="Code" style="font-size: 10pt; font-weight: bold; vertical-align: baseline; font-family: Courier, monospace;">&amp;optional</code>/<code class="Code" style="font-size: 10pt; font-weight: bold; vertical-align: baseline; font-family: Courier, monospace;">&amp;rest</code>/<code class="Code" style="font-size: 10pt; font-weight: bold; vertical-align: baseline; font-family: Courier, monospace;">&amp;key</code>) parameters in the calling function.</li><li class="Step" style="text-align: left; text-indent: 0pt; margin: 6pt 0pt 0pt; font-size: 11pt; vertical-align: baseline; font-family: Palatino, &quot;Palatino Linotype&quot;, serif;"><a name="pgfId-889249" class=""></a>The call has more than 4 arguments and the calling function has&nbsp;<code class="Code" style="font-size: 10pt; font-weight: bold; vertical-align: baseline; font-family: Courier, monospace;">&amp;rest</code>/<code class="Code" style="font-size: 10pt; font-weight: bold; vertical-align: baseline; font-family: Courier, monospace;">&amp;key</code>&nbsp;parameters.</li></ol></div><div class=""></div><div><br class=""><blockquote type="cite" class=""><div class="">Am 04.10.2020 um 08:40 schrieb <a href="mailto:dbm@refined-audiometrics.com" class="">dbm@refined-audiometrics.com</a>:</div><br class="Apple-interchange-newline"><div class=""><meta http-equiv="Content-Type" content="text/html; charset=utf-8" class=""><div style="word-wrap: break-word; -webkit-nbsp-mode: space; line-break: after-white-space;" class="">I FOUND IT!&nbsp;<div class=""><br class=""></div><div class="">As long as you call a Lambda function with simple arguments as the captured continuation, the tail forwarding calls work with TCO. My original macros were expanding the arguments lists so that a function like this:</div><div class=""><br class=""></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(lambda (x) ....)</span></font></div><div class=""><br class=""></div><div class="">were actually expanded to this:</div><div class=""><br class=""></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(lambda (&amp;optional x &amp;rest ignored) ... )</span></font></div><div class=""><br class=""></div><div class="">And that seemingly simple alteration is all that was needed to prevent the TCO inside the Lambda closure.</div><div class=""><br class=""></div><div class="">- DM<br class=""><div class=""><br class=""><blockquote type="cite" class=""><div class="">On Oct 3, 2020, at 6:22 PM, <a href="mailto:dbm@refined-audiometrics.com" class="">dbm@refined-audiometrics.com</a> wrote:</div><br class="Apple-interchange-newline"><div class=""><meta http-equiv="Content-Type" content="text/html; charset=utf-8" class=""><div style="word-wrap: break-word; -webkit-nbsp-mode: space; line-break: after-white-space;" class="">… and with suitable macrology, this condenses nicely into:<div class=""><br class=""></div><div class=""><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(=nlet-tail fact ((n 500))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (if (&lt; n 2)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; (=values 1)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; (=bind (t1)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; (fact (1- n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; (=values (* n t1)))))</span></font></div><div class=""><br class=""></div><div class=""><div class="" style="caret-color: rgb(0, 0, 0);"><font face="Monaco" class="">- David McClain</font></div><div class="" style="caret-color: rgb(0, 0, 0);"><font face="Monaco" class="">Refined Audiometrics Laboratory</font></div><div class="" style="caret-color: rgb(0, 0, 0);"><font face="Monaco" class=""><span class=""><a href="http://refined-audiometrics.com/" class="">refined-audiometrics.com</a></span></font></div><div class="" style="caret-color: rgb(0, 0, 0);"><font face="Monaco" class="">Tucson, AZ, USA</font></div><div class="" style="caret-color: rgb(0, 0, 0);"><font face="Monaco" class=""><br class=""></font></div><div class="" style="caret-color: rgb(0, 0, 0);"><font face="Monaco" class=""><br class=""></font></div></div><div class=""><blockquote type="cite" class=""><div class="">On Oct 3, 2020, at 6:18 PM, <a href="mailto:dbm@refined-audiometrics.com" class="">dbm@refined-audiometrics.com</a> wrote:</div><br class="Apple-interchange-newline"><div class=""><meta http-equiv="Content-Type" content="text/html; charset=utf-8" class=""><div style="word-wrap: break-word; -webkit-nbsp-mode: space; line-break: after-white-space;" class="">Here is what I managed to come up with. It no longer blows the stack. But the runtime is likely suffering a bit, compared to what a direct tail-call could provide...<div class=""><br class=""></div><div class=""><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(define-condition values-signal ()</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; ((args &nbsp;:reader values-signal-args :initarg :args)))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(defun retk (&amp;rest args)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (error (make-condition 'values-signal :args args)))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(defun fwdk (c)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (apply 'funcall (values-signal-args c)))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div></div><div class=""><div class=""><div class=""><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(let ((sav-k #'values)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; (sav-n 5000))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (block myblock</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; (tagbody top</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(let ((k sav-k)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(n sav-n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(return-from myblock</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<font color="#ff225e" class="">(handler-case</font></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(if (&lt; n 2)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(<font color="#ff225e" class="">retk</font> k 1) ;; instead of funcall</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(let ((k (lambda (t1)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (<font color="#ff225e" class="">retk</font> k (* n t1)))))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(setf sav-k k</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sav-n (1- n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(go top)))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <font color="#ff225e" class="">&nbsp;(values-signal (c)</font></span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(block hndlr-block</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(tagbody again</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (handler-case</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (return-from hndlr-block</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (fwdk c))</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (values-signal (cnew)</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (setf c cnew)</span></font></div><div class=""><font face="Monaco" color="#ff225e" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (go again))))))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;))))))</span></font></div></div></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">- David McClain</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">Refined Audiometrics Laboratory</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><a href="http://refined-audiometrics.com/" class="">refined-audiometrics.com</a></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">Tucson, AZ, USA</span></font></div><div class=""><br class=""><blockquote type="cite" class=""><div class="">On Oct 3, 2020, at 11:43 AM, <a href="mailto:dbm@refined-audiometrics.com" class="">dbm@refined-audiometrics.com</a> wrote:</div><br class="Apple-interchange-newline"><div class=""><meta http-equiv="Content-Type" content="text/html; charset=utf-8" class=""><div style="word-wrap: break-word; -webkit-nbsp-mode: space; line-break: after-white-space;" class="">I know that LW can optimize tail calls in many cases. I have seen it many times. But being able to predict when it can occur is next to impossible.<div class=""><br class=""></div><div class="">I have instances where the tail call is through a captured closure stored in a local binding, or in one of the bindings of the closure of the current function. And in those cases it seems that LW refuses to perform a tail call through that pointer, no matter how I declare the optimization to the compiler. There is only a single value that I’m passing to the captured closure, so it isn’t a question of too many args, or keyword args, etc., interfering.</div><div class=""><br class=""></div><div class="">So it seems that compiler declarations are a weak method of invoking what you want, when you absolutely know you should be getting tail calls. Why not implement a Lisp primitive that directly performs a tail call, i.e., JMP with args?</div><div class=""><br class=""></div><div class="">(Stupid) Example that blows the stack:</div><div class=""><br class=""></div><div class=""><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">(let ((sav-k #'values)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; (sav-n 500))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; (block myblock</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; (tagbody top</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(let ((k sav-k)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(n sav-n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(return-from myblock</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(if (&lt; n 2)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(funcall k 1)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(let ((k (let ((k k) &nbsp;;; form our own captures just to be certain...</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (n n)) ;; should not be necessary here</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (lambda (t1)</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (funcall k (* t1 n))))))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(setf sav-k k</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sav-n (1- n))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(go top))</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;))))))</span></font></div></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class=""><br class=""></span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">- David McClain</span></font></div><div class=""><font face="Monaco" class=""><span style="font-style: normal;" class="">Refined Audiometrics Laboratory</span></font></div><div class=""><font face="Monaco" class=""><a href="http://refined-audiometrics.com/" class="">refined-audiometrics.com</a></font></div><div class=""><font face="Monaco" class="">Tucson, AZ, USA</font></div></div></div></blockquote></div><br class=""></div></div></div></blockquote></div><br class=""></div></div></div></blockquote></div><br class=""></div></div></div></blockquote></div><br class=""></div></body></html>

                </article>
               </section>
              </section>
             </div>
            </div>
            <footer class="d-flex justify-content-center">
             <div>
              Updated at: 2020-12-10 08:28 UTC
             </div>
            </footer>
           </body>
          </html>