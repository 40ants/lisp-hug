<!DOCTYPE html>
<html lang=en>
           <head>
            <meta charset=UTF-8>
            <title>Text output at arbitrary angles, and more...</title>
            <link rel=stylesheet
                  href=https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css
                  integrity=sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2
                  crossorigin=anonymous>
            <style>
section.tree {
    padding-left: 2em;
}
section.tree:first-child {
    padding-left: 0;
}
.article-link {
  margin-bottom: 1em;
}
</style>
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9X3G9MMWZP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-9X3G9MMWZP');
</script>

           </head>
           <body>
            <header class="d-flex justify-content-center">
             <nav
                  class="navbar navbar-light bg-light w-100 mx-5 mb-3">
              <a class=navbar-brand href="/">Lisp HUG Maillist Archive</a>
             </nav>
            </header>
            <div class="d-flex justify-content-center">
             <div class="w-100 mx-5 px-3">
              <section class=tree>
               <article class=email>
                <h1>Text output at arbitrary angles, and more...</h1><HTML><BODY style="word-wrap: break-word; -khtml-nbsp-mode: space; -khtml-line-break: after-white-space; ">I finally sat down with the suggestion from John DeSoi -- that was a pretty good hint. But I ended up going directly from the plotting pane at hand, instead of chasing up to the interface and then back down to (hopefully) the same pane...<DIV><BR class="khtml-block-placeholder"></DIV><DIV>vis...    (let ((ns-view (slot-value (capi-internals:representation pane)<DIV>                                                           'capi-cocoa-library::main-view)))</DIV><DIV>                                  .... do stuff with ns-view ....)</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV>That works just great. And so below you will find the Cocoa code (in C and Lisp) for producing text output at arbitrary angles, as well as code for copying a pane into the clipboard as PDF, and for saving the pane itself as a PDF file.</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV><SPAN class="Apple-style-span" style="border-collapse: separate; border-spacing: 0px 0px; color: rgb(0, 0, 0); font-family: Helvetica; font-size: 12px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; text-align: auto; -khtml-text-decorations-in-effect: none; text-indent: 0px; -apple-text-size-adjust: auto; text-transform: none; orphans: 2; white-space: normal; widows: 2; word-spacing: 0px; "><SPAN class="Apple-style-span" style="border-collapse: separate; border-spacing: 0px 0px; color: rgb(0, 0, 0); font-family: Helvetica; font-size: 12px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; text-align: auto; -khtml-text-decorations-in-effect: none; text-indent: 0px; -apple-text-size-adjust: auto; text-transform: none; orphans: 2; white-space: normal; widows: 2; word-spacing: 0px; "><SPAN class="Apple-style-span" style="border-collapse: separate; border-spacing: 0px 0px; color: rgb(0, 0, 0); font-family: Helvetica; font-size: 12px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; text-align: auto; -khtml-text-decorations-in-effect: none; text-indent: 0px; -apple-text-size-adjust: auto; text-transform: none; orphans: 2; white-space: normal; widows: 2; word-spacing: 0px; "><SPAN class="Apple-style-span" style="border-collapse: separate; border-spacing: 0px 0px; color: rgb(0, 0, 0); font-family: Helvetica; font-size: 12px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; text-align: auto; -khtml-text-decorations-in-effect: none; text-indent: 0px; -apple-text-size-adjust: auto; text-transform: none; orphans: 2; white-space: normal; widows: 2; word-spacing: 0px; "><DIV style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">David McClain</DIV><DIV style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">Chief Technical Officer</DIV><DIV style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">Refined Audiometrics Laboratory</DIV><DIV style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">4391 N. Camino Ferreo</DIV><DIV style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">Tucson, AZ  85750</DIV><DIV style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; font: normal normal normal 12px/normal Helvetica; min-height: 14px; "><BR></DIV><DIV style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">email: <A href="mailto:dbm@refined-audiometrics.com">dbm@refined-audiometrics.com</A></DIV><DIV style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">phone: 1.520.390.3995</DIV><DIV style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">web: <A href="http://www.refined-audiometrics.com">http://www.refined-audiometrics.com</A></DIV><DIV style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; ">Skype: dbmcclain</DIV><BR class="Apple-interchange-newline"></SPAN><SPAN></SPAN></SPAN></SPAN></SPAN> </DIV>----------------------------------------------------------------------<BR></DIV><DIV>// C Code for NSPane manipulations...</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV>extern "C" {</DIV><DIV>#import &lt;Cocoa/Cocoa.h&gt;</DIV><DIV>};</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV>static NSAutoreleasePool *_pool;</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV>void pltstuff_init()</DIV><DIV>{</DIV><DIV>  if (!_pool)</DIV><DIV>    _pool = [[NSAutoreleasePool alloc] init];</DIV><DIV>}</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV>void pltstuff_terminate(void)</DIV><DIV>{</DIV><DIV>  [_pool release];</DIV><DIV>  _pool = nil;</DIV><DIV>}</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV>@interface NSFont (NSFontHiddenMethods)</DIV><DIV>- (NSGlyph)_defaultGlyphForChar:(unichar)theChar;</DIV><DIV>@end</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV>typedef struct</DIV><DIV> {</DIV><DIV>   float  red;</DIV><DIV>   float  green;</DIV><DIV>   float  blue;</DIV><DIV>   float  alpha;</DIV><DIV>} colorStruct;</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV>extern "C"</DIV><DIV>void pltstuff_add_label(NSView *view, char* text, float x, float y,</DIV><DIV><SPAN class="Apple-tab-span" style="white-space:pre">			</SPAN>char* font_name, float font_size, colorStruct *color,</DIV><DIV><SPAN class="Apple-tab-span" style="white-space:pre">			</SPAN>long  justification, float angle)</DIV><DIV>{</DIV><DIV>  pltstuff_init();</DIV><DIV>  </DIV><DIV>  int i = 0;</DIV><DIV>  </DIV><DIV>  NSFont *aFont = [NSFont fontWithName:[NSString stringWithCString:font_name]</DIV><DIV><SPAN class="Apple-tab-span" style="white-space:pre">		</SPAN>   size:font_size];</DIV><DIV>  </DIV><DIV>  int strLen = strlen(text);</DIV><DIV>  </DIV><DIV>  NSAffineTransform *aTransform = [NSAffineTransform transform];</DIV><DIV>  NSBezierPath *tmpPath = [NSBezierPath bezierPath];</DIV><DIV>  NSSize tmpSize;</DIV><DIV>  NSPoint adjust = NSZeroPoint;</DIV><DIV>  NSPoint pos = NSZeroPoint;</DIV><DIV>  </DIV><DIV>  //</DIV><DIV>  // appendBezierPathWithGlyph needs a valid context...</DIV><DIV>  //</DIV><DIV>  [view lockFocus];</DIV><DIV>  //</DIV><DIV>  // Create glyphs and convert to path</DIV><DIV>  //</DIV><DIV>  [tmpPath moveToPoint:pos];</DIV><DIV>  </DIV><DIV>  for(i=0; i&lt;strLen; i++)</DIV><DIV>    {</DIV><DIV>      NSGlyph theGlyph;</DIV><DIV>      NSSize offset;</DIV><DIV>      </DIV><DIV>      theGlyph = [aFont _defaultGlyphForChar:(text[i])];</DIV><DIV>      offset = [aFont advancementForGlyph:theGlyph];</DIV><DIV>      [tmpPath appendBezierPathWithGlyph:theGlyph inFont:aFont];</DIV><DIV>      pos.x += offset.width;</DIV><DIV>      pos.y += offset.height;</DIV><DIV>      [tmpPath moveToPoint:pos];</DIV><DIV>    }</DIV><DIV>  tmpSize = [tmpPath bounds].size;</DIV><DIV>  //</DIV><DIV>  // Place the path according to position, angle and align</DIV><DIV>  //   </DIV><DIV>  // hAlign:</DIV><DIV>  adjust.x = -(float)(justification &amp; 0x03)*0.5*tmpSize.width;</DIV><DIV>  // vAlign:</DIV><DIV>  switch (justification &amp; 0x1C)</DIV><DIV>    {</DIV><DIV>    case 0x00:// AQTAlignMiddle: // align middle wrt *font size*</DIV><DIV>      adjust.y = -([aFont descender] + [aFont capHeight])*0.5; </DIV><DIV>      break;</DIV><DIV>    case 0x04:// AQTAlignBaseline: // align baseline (do nothing)</DIV><DIV>      break;</DIV><DIV>    case 0x08:// AQTAlignBottom: // align bottom wrt *bounding box*</DIV><DIV>      adjust.y = -[tmpPath bounds].origin.y;</DIV><DIV>      break;</DIV><DIV>    case 0x10:// AQTAlignTop: // align top wrt *bounding box*</DIV><DIV>      adjust.y = -([tmpPath bounds].origin.y + tmpSize.height) ;</DIV><DIV>      break;</DIV><DIV>    default:</DIV><DIV>      // default to align baseline (do nothing) in case of error</DIV><DIV>      break;</DIV><DIV>    }</DIV><DIV>  </DIV><DIV>  [aTransform translateXBy:x yBy:y];</DIV><DIV>  [aTransform rotateByDegrees:angle];</DIV><DIV>  [aTransform translateXBy:adjust.x yBy:adjust.y]; </DIV><DIV>  [tmpPath transformUsingAffineTransform:aTransform];</DIV><DIV>  [[NSColor colorWithCalibratedRed: (color-&gt;red)</DIV><DIV>    green:(color-&gt;green)</DIV><DIV>    blue: (color-&gt;blue)</DIV><DIV>    alpha:(color-&gt;alpha)] set];</DIV><DIV>  [tmpPath fill];</DIV><DIV>  [view unlockFocus];</DIV><DIV>}</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV>extern "C"</DIV><DIV>void pltstuff_copy_pdf_plot(NSView *view)</DIV><DIV>{</DIV><DIV>   NSPasteboard *pasteboard = [NSPasteboard generalPasteboard];</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV>   [pasteboard declareTypes:[NSArray arrayWithObjects:NSPDFPboardType, NSPostScriptPboardType, nil] owner:nil];</DIV><DIV>   </DIV><DIV>   [pasteboard setData:[view dataWithPDFInsideRect:[view bounds]] forType:NSPDFPboardType];</DIV><DIV>   [pasteboard setData:[view dataWithEPSInsideRect:[view bounds]] forType:NSPostScriptPboardType];</DIV><DIV>}</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV>extern "C"</DIV><DIV>void pltstuff_save_pdf_plot(NSView *view, char *filename)</DIV><DIV>{</DIV><DIV>   NSData   *data;</DIV><DIV>   NSString *fname;</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV>   fname = [[NSString stringWithCString: filename] stringByDeletingPathExtension];</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV>  data = [view dataWithPDFInsideRect: [view bounds]];</DIV><DIV>  [data writeToFile: [fname stringByAppendingPathExtension:@"pdf"] atomically: NO];</DIV><DIV>}</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV>// ------------------------------------------------------------------------------------------------------------</DIV><DIV>#Makefile info for producing a dylib called libLispPlotterStuff.dylib</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV>plotterStuff: plotter-stuff.mm</DIV><DIV><SPAN class="Apple-tab-span" style="white-space:pre">	</SPAN>$(GCC) -o libLispPlotterStuff.dylib \</DIV><DIV><SPAN class="Apple-tab-span" style="white-space:pre">		</SPAN>plotter-stuff.mm<SPAN class="Apple-tab-span" style="white-space:pre">		</SPAN>\</DIV><DIV><SPAN class="Apple-tab-span" style="white-space:pre">		</SPAN>-lstdc++ -framework AppKit</DIV><DIV><SPAN class="Apple-tab-span" style="white-space:pre">	</SPAN>mv libLispPlotterStuff.dylib /usr/local/lib</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV>;; ----------------------------------------------------------------------------------------------------------------</DIV><DIV>;; Lisp code for interfacing to the C library...</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV>(defvar *plotter-stuff-lib* (fli:register-module "/usr/local/lib/libLispPlotterStuff.dylib"))</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV>(fli:define-c-struct (color-struct (:foreign-name "colorStruct"))</DIV><DIV>  (red      :float)</DIV><DIV>  (green    :float)</DIV><DIV>  (blue     :float)</DIV><DIV>  (alpha    :float))</DIV><DIV>                                   </DIV><DIV>(fli:define-foreign-function (_add-label "pltstuff_add_label" :source)</DIV><DIV>    ((view :pointer)</DIV><DIV>     (text (:reference-pass</DIV><DIV>            (:ef-mb-string :limit 256)))</DIV><DIV>     (x    :float)</DIV><DIV>     (y    :float)</DIV><DIV>     (font-name (:reference-pass</DIV><DIV>                 (:ef-mb-string :limit 256)))</DIV><DIV>     (font-size :float)</DIV><DIV>     (color     (:pointer color-struct))</DIV><DIV>     (just      :long)</DIV><DIV>     (angle     :float))</DIV><DIV>  :language :ansi-c</DIV><DIV>  :result-type :void)</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV>(defun fill-color-spec (color-struct color alpha)</DIV><DIV>  (let ((rgb  (if (keywordp color)</DIV><DIV>                  (color:get-color-translation color)</DIV><DIV>                color)))</DIV><DIV>    (setf (fli:foreign-slot-value color-struct 'red)   (float (aref rgb 1) 1.0)</DIV><DIV>          (fli:foreign-slot-value color-struct 'green) (float (aref rgb 2) 1.0)</DIV><DIV>          (fli:foreign-slot-value color-struct 'blue)  (float (aref rgb 3) 1.0)</DIV><DIV>          (fli:foreign-slot-value color-struct 'alpha) (float alpha 1.0)</DIV><DIV>          )))</DIV><DIV>                                      </DIV><DIV>(defun add-label (pane text x y</DIV><DIV>                       &amp;key</DIV><DIV>                       (font "Times-Roman")</DIV><DIV>                       (font-size 12)</DIV><DIV>                       (color :black)</DIV><DIV>                       (alpha 1.0)</DIV><DIV>                       (x-alignment :left)</DIV><DIV>                       (y-alignment :baseline)</DIV><DIV>                       (angle 0.0))</DIV><DIV>  (capi:apply-in-pane-process pane</DIV><DIV>                              (lambda ()</DIV><DIV>                                (fli:with-dynamic-foreign-objects ()</DIV><DIV>                                  (let ((color-struct (fli:allocate-dynamic-foreign-object</DIV><DIV>                                                       :type 'color-struct))</DIV><DIV>                                        (ns-view (slot-value (capi-internals:representation pane)</DIV><DIV>                                                             'capi-cocoa-library::main-view)))</DIV><DIV>                                    (fill-color-spec color-struct color alpha)</DIV><DIV>                                    (_add-label ns-view</DIV><DIV>                                                text</DIV><DIV>                                                (float x 1.0)</DIV><DIV>                                                (float (- (gp:port-height pane) y) 1.0) ;; note NSView y-coords are inverted from pane y-coords</DIV><DIV>                                                font (float font-size 1.0) color-struct</DIV><DIV>                                                (+ (* 4 (ecase y-alignment</DIV><DIV>                                                          (:center   0)</DIV><DIV>                                                          (:baseline 1)</DIV><DIV>                                                          (:bottom   2)</DIV><DIV>                                                          (:top      4)))</DIV><DIV>                                                   (ecase x-alignment</DIV><DIV>                                                     (:left   0)</DIV><DIV>                                                     (:center 1)</DIV><DIV>                                                     (:right  2)))</DIV><DIV>                                                (float angle 1.0))</DIV><DIV>                                    ))</DIV><DIV>                                )))</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV>(fli:define-foreign-function (_copy-pdf-plot "pltstuff_copy_pdf_plot" :source)</DIV><DIV>    ((view :pointer))</DIV><DIV>  :language :ansi-c</DIV><DIV>  :result-type :void)</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV>(defun copy-pdf-plot (pane)</DIV><DIV>  (capi:apply-in-pane-process pane</DIV><DIV>                              (lambda ()</DIV><DIV>                                (let ((ns-view (slot-value (capi-internals:representation pane)</DIV><DIV>                                                           'capi-cocoa-library::main-view)))</DIV><DIV>                                  (_copy-pdf-plot ns-view)))</DIV><DIV>                              ))</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV>(fli:define-foreign-function (_save-pdf-plot "pltstuff_save_pdf_plot" :source)</DIV><DIV>    ((view :pointer)</DIV><DIV>     (filename (:reference-pass</DIV><DIV>                (:ef-mb-string :limit 256))))</DIV><DIV>  :language :ansi-c</DIV><DIV>  :result-type :void)</DIV><DIV><BR class="khtml-block-placeholder"></DIV><DIV>(defun save-pdf-plot (pane filename)</DIV><DIV>  (capi:apply-in-pane-process pane</DIV><DIV>                              (lambda ()</DIV><DIV>                                (let ((ns-view (slot-value (capi-internals:representation pane)</DIV><DIV>                                                           'capi-cocoa-library::main-view)))</DIV><DIV>                                  (_save-pdf-plot ns-view filename)))</DIV><DIV>                              ))</DIV><DIV><BR class="khtml-block-placeholder"></DIV></BODY></HTML>

               </article>
              </section>
             </div>
            </div>
            <footer class="d-flex justify-content-center">
             <div>
              Updated at: 2020-12-07 08:42 UTC
             </div>
            </footer>
           </body>
          </html>