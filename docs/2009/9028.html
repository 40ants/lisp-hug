<!DOCTYPE html>
<html lang=en>
           <head>
            <meta charset=UTF-8>
            <title>Question about DEFINE-MODIFY-MACRO</title>
            <meta name=viewport
                  content="width=device-width, initial-scale=1.0">
            <link rel=stylesheet
                  href=https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css
                  integrity=sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2
                  crossorigin=anonymous>
            <style>
section.tree {
    padding-left: 2em;
}
section.tree:first-child {
    padding-left: 0;
}
.article-link {
  margin-bottom: 1em;
}
</style>
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9X3G9MMWZP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-9X3G9MMWZP');
</script>

           </head>
           <body>
            <header class="d-flex justify-content-center">
             <nav
                  class="navbar navbar-light bg-light w-100 mx-5 mb-3">
              <a class=navbar-brand href="/">Lisp HUG Maillist Archive</a>
             </nav>
            </header>
            <div class="d-flex justify-content-center">
             <div class="w-100 mx-5 px-3">
              <section class=tree>
               <article class=email>
                <h1>Question about DEFINE-MODIFY-MACRO</h1>
                <pre>
Hi, LispWorks

Say given following DEFINE-MODIFY-MACRO definition:

(DEFINE-MODIFY-MACRO XXX-MODIFY-MACRO-USING-TEST (XXX-PUSHNEW XXX- 
PUSHNEW-TEST XXX-PUSHNEW-KEY)
                      XXX-PUSHNEW-FUNCTION-USING-TEST)

When I try to do (macroexpand-1 '(XXX-MODIFY-MACRO-USING-TEST A 0 'EQL  
NIL)), almost every CL give me results like this:

CL-USER(2): (macroexpand-1 '(XXX-MODIFY-MACRO-USING-TEST A 0 'EQL NIL))
(LET* ((#:G100 (XXX-PUSHNEW-FUNCTION-USING-TEST A 0 'EQL NIL)))
   (SETQ A #:G100))
T

Above happens on Allegro CL, and results from SBCL, Clozure CL are  
almost the same. But LispWorks give me following result:

CL-USER 1 &gt (macroexpand-1 '(XXX-MODIFY-MACRO-USING-TEST A 0 'EQL NIL))
(LET* ()
   (LET* ((#:|following-form3994| 0) (#:|following-form3995| 'EQL) (#:| 
following-form3996| NIL))
     (LET ((#:G3993
            (XXX-PUSHNEW-FUNCTION-USING-TEST A
                                             #:|following-form3994|
                                             #:|following-form3995|
                                             #:|following-form3996|)))
       (SETQ A #:G3993))))
T

When XXX-PUSHNEW-FUNCTION-USING-TEST is NOT a function but macro, the  
macro expansion which generated by LispWorks break my code ...

So I want to ask:

1) Is that legal if I use a macro symbol on DEFINE-MODIFY-MACRO's last  
argument?

or

2) Is the behavior of LW's DEFINE-MODIFY-MACRO right?

Thanks very much!!

---
Chun Tian (binghe)


</pre>
               </article>
               <section class=tree>
                <article class=email>
                 <h1>Re: Question about DEFINE-MODIFY-MACRO</h1>
                 <p>
                  Unable to parse email body. Email id is 9029
                </article>
               </section>
               <section class=tree>
                <article class=email>
                 <h1>Re: Question about DEFINE-MODIFY-MACRO</h1>Hi, Martin<div><br></div><div>To produce the same results with other CL implementations WHEN the eval order is relevent, I think out following solution:</div><div><br></div><div><div>(defmacro my-define-modify-macro</div><div>
          (name lambda-list function &amp;rest doc-string-and-declarations)</div><div>  `(progn</div><div>     (define-modify-macro</div><div>         ,name ,lambda-list ,function ,@doc-string-and-declarations)</div><div>
     #+lispworks</div><div>     (define-compiler-macro ,name</div><div>         (&amp;whole form var &amp;rest args)</div><div>       (if (every #&#39;(lambda (x) (or (atom x)</div><div>                                    (eq &#39;quote (car x))))</div>
<div>                  args)</div><div>           (let ((temp (gensym)))</div><div>             `(let ((,temp (,&#39;,function ,var ,@args)))</div><div>                (setq ,var ,temp)))</div><div>         form))))</div>
<div><br></div><div>That is: for atom and quote arguments, just don&#39;t use LW&#39;s DEFINE-MODIFY-MACRO. Now, I got following results:</div><div><br></div><div><div>CL-USER 14 &gt; (funcall (compiler-macro-function &#39;xxx-modify-macro-using-test)</div>
<div> &#39;(xxx-modify-macro-using-test a 0 &#39;eql nil) nil)</div><div><br></div><div>(LET ((#:G940 (XXX-PUSHNEW-FUNCTION-USING-TEST A 0 (QUOTE EQL) NIL))) (SETQ A #:G940))</div><div><br></div><div>CL-USER 15 &gt; (funcall (compiler-macro-function &#39;xxx-modify-macro-using-test)</div>
<div> &#39;(xxx-modify-macro-using-test a 0 (setq a b) nil) nil)</div><div><br></div><div>(XXX-MODIFY-MACRO-USING-TEST A 0 (SETQ A B) NIL)</div><div><br></div><div>Do you think this will work?</div></div><div class="gmail_quote">
<br></div><div class="gmail_quote">Regards,</div><div class="gmail_quote"><br></div><div class="gmail_quote">Chun Tian (binghe)</div><div class="gmail_quote"><br></div><div class="gmail_quote">On Sat, Mar 14, 2009 at 5:32 AM, Martin Simmons <span dir="ltr">&lt;<a href="mailto:martin@lispworks.com">martin@lispworks.com</a>&gt;</span> wrote:<br>
<blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex;"><div><div></div><div class="h5"><br>
&gt;&gt;&gt;&gt;&gt; On Fri, 13 Mar 2009 00:56:32 +0800, Chun Tian (binghe) said:<br>
&gt;<br>
&gt; Hi, LispWorks<br>
&gt;<br>
&gt; Say given following DEFINE-MODIFY-MACRO definition:<br>
&gt;<br>
&gt; (DEFINE-MODIFY-MACRO XXX-MODIFY-MACRO-USING-TEST (XXX-PUSHNEW XXX-<br>
&gt; PUSHNEW-TEST XXX-PUSHNEW-KEY)<br>
&gt;                       XXX-PUSHNEW-FUNCTION-USING-TEST)<br>
&gt;<br>
&gt; When I try to do (macroexpand-1 &#39;(XXX-MODIFY-MACRO-USING-TEST A 0 &#39;EQL<br>
&gt; NIL)), almost every CL give me results like this:<br>
&gt;<br>
&gt; CL-USER(2): (macroexpand-1 &#39;(XXX-MODIFY-MACRO-USING-TEST A 0 &#39;EQL NIL))<br>
&gt; (LET* ((#:G100 (XXX-PUSHNEW-FUNCTION-USING-TEST A 0 &#39;EQL NIL)))<br>
&gt;    (SETQ A #:G100))<br>
&gt; T<br>
&gt;<br>
&gt; Above happens on Allegro CL, and results from SBCL, Clozure CL are<br>
&gt; almost the same. But LispWorks give me following result:<br>
&gt;<br>
&gt; CL-USER 1 &gt; (macroexpand-1 &#39;(XXX-MODIFY-MACRO-USING-TEST A 0 &#39;EQL NIL))<br>
&gt; (LET* ()<br>
&gt;    (LET* ((#:|following-form3994| 0) (#:|following-form3995| &#39;EQL) (#:|<br>
&gt; following-form3996| NIL))<br>
&gt;      (LET ((#:G3993<br>
&gt;             (XXX-PUSHNEW-FUNCTION-USING-TEST A<br>
&gt;                                              #:|following-form3994|<br>
&gt;                                              #:|following-form3995|<br>
&gt;                                              #:|following-form3996|)))<br>
&gt;        (SETQ A #:G3993))))<br>
&gt; T<br>
&gt;<br>
&gt; When XXX-PUSHNEW-FUNCTION-USING-TEST is NOT a function but macro, the<br>
&gt; macro expansion which generated by LispWorks break my code ...<br>
&gt;<br>
&gt; So I want to ask:<br>
&gt;<br>
&gt; 1) Is that legal if I use a macro symbol on DEFINE-MODIFY-MACRO&#39;s last<br>
&gt; argument?<br>
<br>
</div></div>I don&#39;t think ANSI specifies what forms appear in the expansion, though it<br>
does specify order of evaluation (see below).<br>
<div class="im"><br>
<br>
&gt; or<br>
&gt;<br>
&gt; 2) Is the behavior of LW&#39;s DEFINE-MODIFY-MACRO right?<br>
<br>
</div>Yes and I suspect other implementations are slightly wrong.  Consider the<br>
following:<br>
<br>
(defun radjoin (list value)<br>
  (adjoin value list))<br>
<br>
(define-modify-macro rpushnew (value) radjoin)<br>
<br>
(let ((the-list (list 1 2)))<br>
  (rpushnew the-list (setq the-list (list 4 5)))<br>
  the-list)<br>
<br>
According to ANSI 5.1.3<br>
<a href="http://www.lispworks.com/documentation/HyperSpec/Body/05_ac.htm" target="_blank">http://www.lispworks.com/documentation/HyperSpec/Body/05_ac.htm</a>, the<br>
evaluation proceeds in 6 steps.  For the above example, the steps should be<br>
like this:<br>
<br>
1. Skipped (there are no preceding-forms).<br>
2. Skipped (there are no subforms of the place the-list).<br>
3. Evaluate the following-form (setq the-list (list 4 5)).<br>
4. Read the-list, giving (4 5).<br>
5. Compute the new value from (radjoin (4 5) (4 5)), giving ((4 5) 4 5).<br>
6. Store ((4 5) 4 5) into the-list.<br>
<font color="#888888"><br>
--<br>
Martin Simmons<br>
LispWorks Ltd<br>
<a href="http://www.lispworks.com/" target="_blank">http://www.lispworks.com/</a><br>
<br>
</font></blockquote></div><br><br clear="all"><br>-- <br>Chun Tian (binghe)<br>NetEase.com, Inc.<br>
</div>


                </article>
               </section>
               <section class=tree>
                <article class=email>
                 <h1>Re: Question about DEFINE-MODIFY-MACRO</h1>
                 <p>
                  Unable to parse email body. Email id is 9151
                </article>
               </section>
              </section>
             </div>
            </div>
            <footer class="d-flex justify-content-center">
             <div>
              Updated at: 2020-12-10 08:41 UTC
             </div>
            </footer>
           </body>
          </html>